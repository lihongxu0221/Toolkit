using MultiLingualTranslation.Helpers;using Newtonsoft.Json;using System.Net.Http;using System.Net.Http.Headers;using System.Security.Cryptography;using System.Text;namespace MultiLingualTranslation.Services;public class TranslationService{    private const string AppId = "20260119002542859";    private const string SecretKey = "Rd5TTMYwgEiYLJHXQWCl";    private const string TranslateApiUrl = "https://fanyi-api.baidu.com/api/trans/vip/translate";    private readonly HttpClient httpClient;    public TranslationService(HttpClient httpClient)    {        this.httpClient = httpClient ?? new HttpClient();    }    /// <summary>    /// 单文本翻译Post方式.（适配百度翻译API，可批量扩展）.    /// </summary>    /// <param name="sourceLang">源语言（如：auto 自动识别、zh 中文、en 英文）.</param>    /// <param name="targetLang">目标语言（如：en 英文、ja 日语、fr 法语，需符合百度API规范）.</param>    /// <param name="items">待翻译的资源列表.</param>    /// <returns>翻译后的结果列表.</returns>    public async Task<List<TranslateItem>> TranslatePostAsync(        string sourceLang,        string targetLang,        params TranslateItem[] items)    {        var translatedTexts = new List<TranslateItem>(items);        if (items.Length > 0)        {            if (sourceLang == targetLang)            {                for (int i = 0; i < translatedTexts.Count; i++)                {                    translatedTexts[i].Dst = translatedTexts[i].Src;                }                return translatedTexts;            }            string[] sourceTexts = new string[items.Length];            for (int i = 0; i < sourceTexts.Length; i++)            {                sourceTexts[i] = items[i].Src;            }            var qs = TextSplitter.SplitToMaxLength(6000, sourceTexts);            foreach (var q in qs)            {                // 1. 生成百度翻译API签名（必填，防止请求篡改）                var salt = Guid.NewGuid().ToString(); // 随机盐值                var signStr = $"{AppId}{q}{salt}{SecretKey}";                var sign = ComputeMd5(signStr); // MD5加密生成签名                // 构造POST表单参数                var formData = new Dictionary<string, string>                {                    { "q", q },          // 待翻译文本                    { "from", sourceLang },   // 源语言                    { "to", targetLang },       // 目标语言                    { "appid", AppId },    // AppId                    { "salt", salt.ToString() }, // 盐值                    { "sign", sign },        // 签名                };                try                {                    // 构造表单内容（FormUrlEncodedContent默认会设置Content-Type为application/x-www-form-urlencoded）                    var content = new FormUrlEncodedContent(formData);                    // 显式指定Content-Type，严格匹配开发文档要求（可选但推荐）                    content.Headers.ContentType = new MediaTypeHeaderValue("application/x-www-form-urlencoded")                    {                        // 补充字符编码，避免中文乱码（关键！）                        CharSet = "UTF-8",                    };                    // 发送POST请求                    var response = await httpClient.PostAsync(TranslateApiUrl, content);                    response.EnsureSuccessStatusCode(); // 抛出HTTP错误状态码异常                    // 解析JSON响应                    string responseJson = await response.Content.ReadAsStringAsync();                    var translateResponse = JsonConvert.DeserializeObject<BaiduTranslateResponse>(responseJson);                    // 处理翻译结果                    if (translateResponse == null ||                        translateResponse.TransResult == null ||                        translateResponse.TransResult.Count == 0)                    {                        throw new InvalidOperationException($"翻译失败：{responseJson}");                    }                    // 替换无效字符                    for (int i = 0; i < translateResponse.TransResult.Count; i++)                    {                        var result = translateResponse.TransResult[i];                        result.Dst = result.Dst.Replace('｛', '{').Replace('｝', '}');                    }                    if (translateResponse.TransResult.Count == 1)                    {                        string[] srcs = translateResponse.TransResult[0].Src.Split(Environment.NewLine);                        string[] dsts = translateResponse.TransResult[0].Dst.Split(Environment.NewLine);                        if (srcs.Length == dsts.Length)                        {                            for (int i = 0; i < srcs.Length; i++)                            {                                var existingItem = translatedTexts.FirstOrDefault(t => t.Src == srcs[i]);                                if (existingItem != null)                                {                                    existingItem.Dst = dsts[i];                                }                            }                        }                    }                    else                    {                        // 拼接翻译结果（支持多段文本）                        foreach (var item in translateResponse.TransResult)                        {                            var existingItem = translatedTexts.FirstOrDefault(t => t.Src == item.Src);                            if (existingItem != null)                            {                                existingItem.Dst = item.Dst;                            }                        }                    }                    // 可选：添加延时，避免触发接口限流（百度翻译API有调用频率限制）                    await Task.Delay(100);                }                catch (Exception ex)                {                    throw new InvalidOperationException($"调用百度翻译API失败：{ex.Message}", ex);                }            }        }        return translatedTexts;    }    /// <summary>    /// 单文本翻译（适配百度翻译API，可批量扩展）.    /// </summary>    /// <param name="sourceText">待翻译文本.</param>    /// <param name="sourceLang">源语言（如：auto 自动识别、zh 中文、en 英文）.</param>    /// <param name="targetLang">目标语言（如：en 英文、ja 日语、fr 法语，需符合百度API规范）.</param>    /// <returns>翻译后的文本</returns>    public async Task<string> TranslateTextAsync(string sourceText, string sourceLang = "auto", string targetLang = "en")    {        // 空值直接返回，避免无效调用        if (string.IsNullOrEmpty(sourceText))        {            return string.Empty;        }        try        {            // 1. 生成百度翻译API签名（必填，防止请求篡改）            var salt = Guid.NewGuid().ToString(); // 随机盐值            var signStr = $"{AppId}{sourceText}{salt}{SecretKey}";            var sign = ComputeMd5(signStr); // MD5加密生成签名            // 2. 构造请求参数（URL编码，避免中文乱码）            var requestParams = new Dictionary<string, string>            {                ["q"] = Uri.EscapeDataString(sourceText),                ["from"] = sourceLang,                ["to"] = targetLang,                ["appid"] = AppId,                ["salt"] = salt,                ["sign"] = sign,            };            // 3. 构造完整请求URL            var queryString = string.Join("&", requestParams.Select(kv => $"{kv.Key}={kv.Value}"));            var fullRequestUrl = $"{TranslateApiUrl}?{queryString}";            // 4. 发送HTTP GET请求，获取翻译结果            var response = await httpClient.GetAsync(fullRequestUrl);            response.EnsureSuccessStatusCode(); // 确保请求成功            var responseJson = await response.Content.ReadAsStringAsync();            // 5. 解析JSON返回结果（百度翻译API返回格式）            var translateResult = JsonConvert.DeserializeObject<BaiduTranslateResponse>(responseJson);            if (translateResult?.TransResult == null || translateResult.TransResult.Count == 0)            {                return sourceText; // 翻译失败返回原文            }            return translateResult.TransResult[0].Dst;        }        catch (Exception ex)        {            Console.WriteLine($"翻译失败：{ex.Message}，文本：{sourceText}");            return sourceText; // 异常时返回原文，避免中断整体流程        }    }    /// <summary>    /// MD5加密（生成百度翻译API签名）.    /// </summary>    private static string ComputeMd5(string input)    {        using (var md5 = MD5.Create())        {            var inputBytes = Encoding.UTF8.GetBytes(input);            var hashBytes = md5.ComputeHash(inputBytes);            var sb = new StringBuilder();            foreach (var b in hashBytes)            {                sb.Append(b.ToString("x2")); // 转为小写16进制字符串            }            return sb.ToString();        }    }    /// <summary>    /// 百度翻译API返回结果模型（简化版）.    /// </summary>    public class BaiduTranslateResponse    {        [JsonProperty("from")]        public string From { get; set; }        [JsonProperty("to")]        public string To { get; set; }        [JsonProperty("error_code")]        public string ErrorCode { get; set; }        [JsonProperty("error_msg")]        public string ErrorMsg { get; set; }        [JsonProperty("trans_result")]        public List<TranslateItem> TransResult { get; set; }    }    public class TranslateItem    {        [JsonIgnore]        public string Key { get; set; } // 多语言Key（非API字段，仅本地使用）        [JsonProperty("src")]        public string Src { get; set; } // 原文        [JsonProperty("dst")]        public string Dst { get; set; } // 译文        public override string ToString()        {            return $"{Key},{Src},{Dst}";        }    }}