using BgControls.Windows.Datas;namespace BgControls.Tools.Converter;/// <summary>/// 对象相等性到可见性的转换器./// </summary>/// <remarks>/// <para>/// 将绑定的值 (<c>value</c>) 与转换器参数 (<c>parameter</c>) 进行比较./// </para>/// <para>/// 如果相等，返回 <see cref="EqualsValue"/> (默认 Visible)；/// 如果不相等，返回 <see cref="NotEqualsValue"/> (默认 Collapsed)./// </para>/// </remarks>public class Equality2ValueConverter : IValueConverter{    /// <summary>    /// Initializes a new instance of the <see cref="Equality2ValueConverter" /> class.    /// </summary>    public Equality2ValueConverter()    {        this.EqualsValue = ValueBoxes.TrueBox;        this.NotEqualsValue = ValueBoxes.FalseBox;    }    /// <summary>    /// Gets or sets 预设的用于比对的目标值.    /// </summary>    /// <remarks>    /// 如果设置了此属性，转换器将优先使用此值进行比对，而不是使用 ConverterParameter.    /// </remarks>    public object? CompareValue { get; set; }    /// <summary>    /// Gets or sets 当值与参数相等时的返回值.    /// </summary>    /// <value>默认为 <see cref="ValueBoxes.TrueBox"/>.</value>    public object EqualsValue { get; set; }    /// <summary>    /// Gets or sets 当值与参数不相等时的返回值.    /// </summary>    /// <value>默认为 <see cref="ValueBoxes.FalseBox"/>.</value>    public object NotEqualsValue { get; set; }    /// <summary>    /// 正向转换：比较值与参数，返回对应结果.    /// </summary>    /// <param name="value">绑定源产生的值.</param>    /// <param name="targetType">绑定目标属性的类型.</param>    /// <param name="parameter">要比较的参数.</param>    /// <param name="culture">区域信息.</param>    /// <returns>返回 <see cref="EqualsValue"/> 或 <see cref="NotEqualsValue"/>.</returns>    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)    {        // 确定最终用于比对的目标值：优先使用属性设置，其次使用参数.        object? targetCompareValue = this.CompareValue ?? parameter;        if (CheckEquals(value, targetCompareValue, culture))        {            return this.EqualsValue;        }        return this.NotEqualsValue;    }    /// <summary>    /// 反向转换：通常用于双向绑定 (如 RadioButton).    /// </summary>    /// <param name="value">UI 控件产生的值 (如 IsChecked 的 bool 值).</param>    /// <param name="targetType">源数据属性的类型.</param>    /// <param name="parameter">转换器参数 (即该控件代表的枚举/数值).</param>    /// <param name="culture">区域信息.</param>    /// <returns>    /// 如果 <paramref name="value"/> 等于 <see cref="EqualsValue"/>，则返回 <paramref name="parameter"/>；    /// 否则返回 <see cref="Binding.DoNothing"/>.    /// </returns>    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)    {        // 确定比对目标.        object? targetCompareValue = this.CompareValue ?? parameter;        // 逻辑：只有当 UI 的状态变成了 "选中/可见" (即等于 EqualsValue) 时，        // 我们才需要更新源数据.例如 RadioButton 被选中时，更新 Enum.        // RadioButton 取消选中时，不需要把源数据更新为 null 或其他值.        if (CheckEquals(value, this.EqualsValue, culture))        {            try            {                // 处理 Nullable<T> 类型，防止 ChangeType 失败                var conversionType = Nullable.GetUnderlyingType(targetType) ?? targetType;                // 将 parameter 转换回源数据的目标类型                return System.Convert.ChangeType(targetCompareValue, conversionType, culture);            }            catch            {                // 如果转换失败 (例如目标是复杂对象)，直接返回 parameter                return targetCompareValue;            }        }        return Binding.DoNothing;    }    /// <summary>    /// 内部辅助方法：检查两个对象在宽容模式下是否相等.    /// </summary>    private static bool CheckEquals(object value1, object value2, CultureInfo culture)    {        // 1. 双 null        if (value1 == null && value2 == null)        {            return true;        }        // 2. 单 null        if (value1 == null || value2 == null)        {            return false;        }        // 3. 直接引用/值比较        if (object.Equals(value1, value2))        {            return true;        }        // 4. 类型转换比较 (处理 int vs string 等情况)        try        {            var convertedValue2 = System.Convert.ChangeType(value2, value1.GetType(), culture);            if (value1.Equals(convertedValue2))            {                return true;            }            else            {                return false;            }        }        catch        {            // 忽略转换异常        }        // 5. 字符串比较 (处理 Enum 等)        string? s1 = value1.ToString();        string? s2 = value2.ToString();        return string.Equals(s1, s2, StringComparison.Ordinal);    }}