using BgControls.Core.Utilities;using BgControls.Windows.Automation.Peers;using BgControls.Windows.Controls.PropertyGrid;using System.Windows.Automation.Peers;namespace BgControls.Windows.Controls;/// <summary>/// 表示处理 ItemDeleting 路由事件的方法./// </summary>/// <param name="sender">事件源.</param>/// <param name="e">事件数据.</param>public delegate void ItemDeletingRoutedEventHandler(object sender, ItemDeletingEventArgs e);/// <summary>/// 表示处理 ItemDeleted 路由事件的方法./// </summary>/// <param name="sender">事件源.</param>/// <param name="e">事件数据.</param>public delegate void ItemDeletedRoutedEventHandler(object sender, ItemEventArgs e);/// <summary>/// 表示处理 ItemAdding 路由事件的方法./// </summary>/// <param name="sender">事件源.</param>/// <param name="e">事件数据.</param>public delegate void ItemAddingRoutedEventHandler(object sender, ItemAddingEventArgs e);/// <summary>/// 表示处理 ItemAdded 路由事件的方法./// </summary>/// <param name="sender">事件源.</param>/// <param name="e">事件数据.</param>public delegate void ItemAddedRoutedEventHandler(object sender, ItemEventArgs e);/// <summary>/// 表示处理 ItemMovedDown 路由事件的方法./// </summary>/// <param name="sender">事件源.</param>/// <param name="e">事件数据.</param>public delegate void ItemMovedDownRoutedEventHandler(object sender, ItemEventArgs e);/// <summary>/// 表示处理 ItemMovedUp 路由事件的方法./// </summary>/// <param name="sender">事件源.</param>/// <param name="e">事件数据.</param>public delegate void ItemMovedUpRoutedEventHandler(object sender, ItemEventArgs e);/// <summary>/// 集合编辑控件，允许用户查看和编辑集合中的项./// </summary>[TemplatePart(Name = CollectionControl.PART_NewItemTypesComboBox, Type = typeof(ComboBox))][TemplatePart(Name = CollectionControl.PART_PropertyGrid, Type = typeof(PropertyGrid.PropertyGrid))][TemplatePart(Name = CollectionControl.PART_ListBox, Type = typeof(ListBox))]public class CollectionControl : Control{    public const string PART_NewItemTypesComboBox = "PART_NewItemTypesComboBox";    public const string PART_PropertyGrid = "PART_PropertyGrid";    public const string PART_ListBox = "PART_ListBox";    /// <summary>    /// 标识 IsReadOnly 依赖属性.    /// </summary>    public static readonly DependencyProperty IsReadOnlyProperty =        DependencyProperty.Register("IsReadOnly", typeof(bool), typeof(CollectionControl), new UIPropertyMetadata(false));    /// <summary>    /// 标识 Items 依赖属性.    /// </summary>    public static readonly DependencyProperty ItemsProperty =        DependencyProperty.Register("Items", typeof(ObservableCollection<object>), typeof(CollectionControl), new UIPropertyMetadata(null));    /// <summary>    /// 标识 ItemsSource 依赖属性.    /// </summary>    public static readonly DependencyProperty ItemsSourceProperty =        DependencyProperty.Register("ItemsSource", typeof(IEnumerable), typeof(CollectionControl), new UIPropertyMetadata(null, OnItemsSourceChanged));    /// <summary>    /// 标识 ItemsSourceType 依赖属性.    /// </summary>    public static readonly DependencyProperty ItemsSourceTypeProperty =        DependencyProperty.Register("ItemsSourceType", typeof(Type), typeof(CollectionControl), new UIPropertyMetadata(null));    /// <summary>    /// 标识 NewItemTypes 依赖属性.    /// </summary>    public static readonly DependencyProperty NewItemTypesProperty =        DependencyProperty.Register("NewItemTypes", typeof(IList), typeof(CollectionControl), new UIPropertyMetadata(null));    /// <summary>    /// 标识 PropertiesLabel 依赖属性.    /// </summary>    public static readonly DependencyProperty PropertiesLabelProperty =        DependencyProperty.Register("PropertiesLabel", typeof(object), typeof(CollectionControl), new UIPropertyMetadata("Properties:"));    /// <summary>    /// 标识 SelectedItem 依赖属性.    /// </summary>    public static readonly DependencyProperty SelectedItemProperty =        DependencyProperty.Register("SelectedItem", typeof(object), typeof(CollectionControl), new UIPropertyMetadata(null));    /// <summary>    /// 标识 TypeSelectionLabel 依赖属性.    /// </summary>    public static readonly DependencyProperty TypeSelectionLabelProperty =        DependencyProperty.Register("TypeSelectionLabel", typeof(object), typeof(CollectionControl), new UIPropertyMetadata("Select type:"));    /// <summary>    /// 标识 EditorDefinitions 依赖属性.    /// </summary>    public static readonly DependencyProperty EditorDefinitionsProperty =        DependencyProperty.Register("EditorDefinitions", typeof(EditorDefinitionCollection), typeof(CollectionControl), new UIPropertyMetadata(null));    /// <summary>    /// 标识 ItemDeleting 路由事件.    /// </summary>    public static readonly RoutedEvent ItemDeletingEvent =        EventManager.RegisterRoutedEvent("ItemDeleting", RoutingStrategy.Bubble, typeof(ItemDeletingRoutedEventHandler), typeof(CollectionControl));    /// <summary>    /// 标识 ItemDeleted 路由事件.    /// </summary>    public static readonly RoutedEvent ItemDeletedEvent =        EventManager.RegisterRoutedEvent("ItemDeleted", RoutingStrategy.Bubble, typeof(ItemDeletedRoutedEventHandler), typeof(CollectionControl));    /// <summary>    /// 标识 ItemAdding 路由事件.    /// </summary>    public static readonly RoutedEvent ItemAddingEvent =        EventManager.RegisterRoutedEvent("ItemAdding", RoutingStrategy.Bubble, typeof(ItemAddingRoutedEventHandler), typeof(CollectionControl));    /// <summary>    /// 标识 ItemAdded 路由事件.    /// </summary>    public static readonly RoutedEvent ItemAddedEvent =        EventManager.RegisterRoutedEvent("ItemAdded", RoutingStrategy.Bubble, typeof(ItemAddedRoutedEventHandler), typeof(CollectionControl));    /// <summary>    /// 标识 ItemMovedDown 路由事件.    /// </summary>    public static readonly RoutedEvent ItemMovedDownEvent =        EventManager.RegisterRoutedEvent("ItemMovedDown", RoutingStrategy.Bubble, typeof(ItemMovedDownRoutedEventHandler), typeof(CollectionControl));    /// <summary>    /// 标识 ItemMovedUp 路由事件.    /// </summary>    public static readonly RoutedEvent ItemMovedUpEvent =        EventManager.RegisterRoutedEvent("ItemMovedUp", RoutingStrategy.Bubble, typeof(ItemMovedUpRoutedEventHandler), typeof(CollectionControl));    static CollectionControl()    {        FrameworkElement.DefaultStyleKeyProperty.OverrideMetadata(            typeof(CollectionControl),            new FrameworkPropertyMetadata(typeof(CollectionControl)));    }    private ComboBox? newItemTypesComboBox;    private PropertyGrid.PropertyGrid? propertyGrid;    private ListBox? listBox;    private bool isCollectionUpdated;    /// <summary>    /// Initializes a new instance of the <see cref="CollectionControl"/> class.    /// </summary>    public CollectionControl()    {        this.Items = new ObservableCollection<object>();        this.CommandBindings.Add(new CommandBinding(ApplicationCommands.New, AddNew, CanAddNew));        this.CommandBindings.Add(new CommandBinding(ApplicationCommands.Delete, Delete, CanDelete));        this.CommandBindings.Add(new CommandBinding(ApplicationCommands.Copy, Duplicate, CanDuplicate));        this.CommandBindings.Add(new CommandBinding(ComponentCommands.MoveDown, MoveDown, CanMoveDown));        this.CommandBindings.Add(new CommandBinding(ComponentCommands.MoveUp, MoveUp, CanMoveUp));    }    /// <summary>    /// Gets or sets a value indicating whether 一个值，该值指示 CollectionControl 是否为只读.    /// </summary>    public bool IsReadOnly    {        get { return (bool)GetValue(IsReadOnlyProperty); }        set { SetValue(IsReadOnlyProperty, value); }    }    /// <summary>    /// Gets or sets 用于生成 CollectionControl 内容的集合.    /// </summary>    public ObservableCollection<object> Items    {        get { return (ObservableCollection<object>)GetValue(ItemsProperty); }        set { SetValue(ItemsProperty, value); }    }    /// <summary>    /// Gets or sets 用于生成 CollectionControl 内容的源列表.    /// </summary>    public IEnumerable? ItemsSource    {        get { return (IEnumerable)GetValue(ItemsSourceProperty); }        set { SetValue(ItemsSourceProperty, value); }    }    /// <summary>    /// Gets or sets  ItemsSource 的类型.    /// </summary>    public Type ItemsSourceType    {        get { return (Type)GetValue(ItemsSourceTypeProperty); }        set { SetValue(ItemsSourceTypeProperty, value); }    }    /// <summary>    /// Gets or sets 显示在添加下拉框中的自定义项类型列表.    /// </summary>    public IList<Type> NewItemTypes    {        get { return (IList<Type>)GetValue(NewItemTypesProperty); }        set { SetValue(NewItemTypesProperty, value); }    }    /// <summary>    /// Gets or sets 属性标签的内容（PropertyGrid 上方的标签）.    /// </summary>    public object PropertiesLabel    {        get { return GetValue(PropertiesLabelProperty); }        set { SetValue(PropertiesLabelProperty, value); }    }    /// <summary>    /// Gets or sets 当前选中的项.    /// </summary>    public object SelectedItem    {        get { return GetValue(SelectedItemProperty); }        set { SetValue(SelectedItemProperty, value); }    }    /// <summary>    /// Gets or sets 类型选择标签的内容（ComboBox 上方的标签）.    /// </summary>    public object TypeSelectionLabel    {        get { return GetValue(TypeSelectionLabelProperty); }        set { SetValue(TypeSelectionLabelProperty, value); }    }    /// <summary>    /// Gets or sets  CollectionControl 中 PropertyGrid 的自定义编辑器.    /// </summary>    public EditorDefinitionCollection EditorDefinitions    {        get { return (EditorDefinitionCollection)GetValue(EditorDefinitionsProperty); }        set { SetValue(EditorDefinitionsProperty, value); }    }    /// <summary>    /// Gets 与 CollectionControl 关联的 PropertyGrid.    /// </summary>    public PropertyGrid.PropertyGrid? PropertyGrid    {        get        {            if (this.propertyGrid == null)            {                this.ApplyTemplate();            }            return this.propertyGrid;        }    }    /// <summary>    /// 当项即将从 CollectionControl 中删除时引发.    /// </summary>    public event ItemDeletingRoutedEventHandler ItemDeleting    {        add { AddHandler(ItemDeletingEvent, value); }        remove { RemoveHandler(ItemDeletingEvent, value); }    }    /// <summary>    /// 当项已从 CollectionControl 中删除时引发.    /// </summary>    public event ItemDeletedRoutedEventHandler ItemDeleted    {        add { AddHandler(ItemDeletedEvent, value); }        remove { RemoveHandler(ItemDeletedEvent, value); }    }    /// <summary>    /// 当项即将添加到 CollectionControl 时引发.    /// </summary>    public event ItemAddingRoutedEventHandler ItemAdding    {        add { AddHandler(ItemAddingEvent, value); }        remove { RemoveHandler(ItemAddingEvent, value); }    }    /// <summary>    /// 当项已添加到 CollectionControl 时引发.    /// </summary>    public event ItemAddedRoutedEventHandler ItemAdded    {        add { AddHandler(ItemAddedEvent, value); }        remove { RemoveHandler(ItemAddedEvent, value); }    }    /// <summary>    /// 当项在 CollectionControl 中下移时引发.    /// </summary>    public event ItemMovedDownRoutedEventHandler ItemMovedDown    {        add { AddHandler(ItemMovedDownEvent, value); }        remove { RemoveHandler(ItemMovedDownEvent, value); }    }    /// <summary>    /// 当项在 CollectionControl 中上移时引发.    /// </summary>    public event ItemMovedUpRoutedEventHandler ItemMovedUp    {        add { AddHandler(ItemMovedUpEvent, value); }        remove { RemoveHandler(ItemMovedUpEvent, value); }    }    /// <summary>    /// 当 ItemsSource 属性发生更改时调用.    /// </summary>    private static void OnItemsSourceChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)    {        ((CollectionControl)d)?.OnItemSourceChanged((IEnumerable)e.OldValue, (IEnumerable)e.NewValue);    }    /// <summary>    /// 处理 ItemsSource 的更改逻辑.    /// </summary>    /// <param name="oldValue">旧值.</param>    /// <param name="newValue">新值.</param>    public void OnItemSourceChanged(IEnumerable oldValue, IEnumerable newValue)    {        if (newValue != null)        {            if (newValue is IDictionary dict)            {                foreach (DictionaryEntry item in dict)                {                    var keyType = (item.Key != null) ?                        item.Key.GetType() :                        (dict.GetType().GetGenericArguments().Length > 0) ? dict.GetType().GetGenericArguments()[0] : typeof(object);                    var valueType = (item.Value != null) ?                        item.Value.GetType() :                        (dict.GetType().GetGenericArguments().Length > 1) ? dict.GetType().GetGenericArguments()[1] : typeof(object);                    var editableKeyValuePair = ListUtilities.CreateEditableKeyValuePair(item.Key, keyType, item.Value, valueType);                    if (editableKeyValuePair != null)                    {                        this.Items.Add(editableKeyValuePair);                    }                }            }            else            {                foreach (object item in newValue)                {                    if (item != null)                    {                        this.Items.Add(item);                    }                }            }        }    }    /// <inheritdoc/>    public override void OnApplyTemplate()    {        base.OnApplyTemplate();        if (this.newItemTypesComboBox != null)        {            this.newItemTypesComboBox.Loaded -= NewItemTypesComboBox_Loaded;        }        this.newItemTypesComboBox = this.GetTemplateChild("PART_NewItemTypesComboBox") as ComboBox;        if (this.newItemTypesComboBox != null)        {            this.newItemTypesComboBox.Loaded += NewItemTypesComboBox_Loaded;        }        this.listBox = this.GetTemplateChild("PART_ListBox") as ListBox;        if (this.propertyGrid != null)        {            this.propertyGrid.PropertyValueChanged -= PropertyGrid_PropertyValueChanged;        }        this.propertyGrid = GetTemplateChild("PART_PropertyGrid") as PropertyGrid.PropertyGrid;        if (this.propertyGrid != null)        {            this.propertyGrid.PropertyValueChanged += PropertyGrid_PropertyValueChanged;        }    }    /// <inheritdoc/>    protected override AutomationPeer OnCreateAutomationPeer()    {        return new GenericAutomationPeer(this);    }    private void NewItemTypesComboBox_Loaded(object sender, RoutedEventArgs e)    {        if (this.newItemTypesComboBox != null)        {            this.newItemTypesComboBox.SelectedIndex = 0;        }    }    private void PropertyGrid_PropertyValueChanged(object sender, PropertyValueChangedEventArgs e)    {        if (listBox != null)        {            this.isCollectionUpdated = true;            this.listBox.Dispatcher.BeginInvoke(DispatcherPriority.Input, () => listBox.Items.Refresh());        }    }    private void AddNew(object sender, ExecutedRoutedEventArgs e)    {        var newItem = this.CreateNewItem((Type)e.Parameter);        this.AddNewCore(newItem);    }    private void CanAddNew(object sender, CanExecuteRoutedEventArgs e)    {        Type? t = e.Parameter as Type;        CanAddNewCore(t, e);    }    private void CanAddNewCore(Type? t, CanExecuteRoutedEventArgs e)    {        if (t != null && !this.IsReadOnly)        {            var isComplexStruct = t.IsValueType && !t.IsEnum && !t.IsPrimitive;            if (isComplexStruct || (t.GetConstructor(Type.EmptyTypes) != null))            {                e.CanExecute = true;            }        }    }    private void AddNewCore(object? newItem)    {        ArgumentNullException.ThrowIfNull(newItem, nameof(newItem));        var e = new ItemAddingEventArgs(ItemAddingEvent, newItem);        this.RaiseEvent(e);        if (!e.Cancel)        {            newItem = e.Item;            this.Items.Add(newItem);            this.RaiseEvent(new ItemEventArgs(ItemAddedEvent, newItem));            this.isCollectionUpdated = true;            this.SelectedItem = newItem;        }    }    private void Delete(object sender, ExecutedRoutedEventArgs e)    {        var eventArgs = new ItemDeletingEventArgs(ItemDeletingEvent, e.Parameter);        this.RaiseEvent(eventArgs);        if (eventArgs.Cancel)        {            return;        }        this.Items.Remove(e.Parameter);        this.RaiseEvent(new ItemEventArgs(ItemDeletedEvent, e.Parameter));        this.isCollectionUpdated = true;    }    private void CanDelete(object sender, CanExecuteRoutedEventArgs e)    {        e.CanExecute = e.Parameter != null && !IsReadOnly;    }    private void Duplicate(object sender, ExecutedRoutedEventArgs e)    {        var newItem = DuplicateItem(e);        this.AddNewCore(newItem);    }    private void CanDuplicate(object sender, CanExecuteRoutedEventArgs e)    {        var t = (e.Parameter != null) ? e.Parameter.GetType() : null;        this.CanAddNewCore(t, e);    }    private object? DuplicateItem(ExecutedRoutedEventArgs e)    {        ArgumentNullException.ThrowIfNull(e, nameof(e));        var baseItem = e.Parameter;        var newItemType = baseItem.GetType();        if (typeof(ICloneable).IsAssignableFrom(newItemType))        {            return ((ICloneable)baseItem).Clone();        }        var newItem = this.CreateNewItem(newItemType);        var type = newItemType;        while (type != null)        {            var baseProperties = type.GetFields(BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic);            foreach (var prop in baseProperties)            {                prop.SetValue(newItem, prop.GetValue(baseItem));            }            type = type.BaseType;        }        return newItem;    }    private void MoveDown(object sender, ExecutedRoutedEventArgs e)    {        var selectedItem = e.Parameter;        var index = Items.IndexOf(selectedItem);        this.Items.RemoveAt(index);        this.Items.Insert(++index, selectedItem);        this.RaiseEvent(new ItemEventArgs(ItemMovedDownEvent, selectedItem));        this.isCollectionUpdated = true;        this.SelectedItem = selectedItem;    }    private void CanMoveDown(object sender, CanExecuteRoutedEventArgs e)    {        if (e.Parameter != null && this.Items.IndexOf(e.Parameter) < this.Items.Count - 1 && !this.IsReadOnly)        {            e.CanExecute = true;        }    }    private void MoveUp(object sender, ExecutedRoutedEventArgs e)    {        var selectedItem = e.Parameter;        var index = Items.IndexOf(selectedItem);        this.Items.RemoveAt(index);        this.Items.Insert(--index, selectedItem);        this.RaiseEvent(new ItemEventArgs(ItemMovedUpEvent, selectedItem));        this.isCollectionUpdated = true;        this.SelectedItem = selectedItem;    }    private void CanMoveUp(object sender, CanExecuteRoutedEventArgs e)    {        if (e.Parameter != null && Items.IndexOf(e.Parameter) > 0 && !IsReadOnly)        {            e.CanExecute = true;        }    }    /// <summary>    /// 将 ObservableCollection 中的更改持久化保存回底层的 ItemsSource.    /// </summary>    /// <returns>如果集合已更新则返回 true.</returns>    public bool PersistChanges()    {        this.PersistChanges(Items);        return isCollectionUpdated;    }    /// <summary>    /// 将源列表中的更改应用到 ItemsSource.    /// </summary>    /// <param name="sourceList">包含当前数据的源列表.</param>    internal void PersistChanges(IList sourceList)    {        var collection = ComputeItemsSource();        if (collection == null)        {            return;        }        if (collection is IDictionary)        {            var dict = (IDictionary)collection;            dict.Clear();            foreach (object source in sourceList)            {                var propInfoKey = source.GetType().GetProperty("Key");                var propInfoValue = source.GetType().GetProperty("Value");                if (propInfoKey != null && propInfoValue != null)                {                    dict.Add(propInfoKey.GetValue(source, null), propInfoValue.GetValue(source, null));                }            }        }        else if (collection is IList)        {            var list = (IList)collection;            list.Clear();            if (list.IsFixedSize)            {                if (sourceList.Count > list.Count)                {                    throw new IndexOutOfRangeException("Exceeding array size.");                }                for (int i = 0; i < sourceList.Count; i++)                {                    list[i] = sourceList[i];                }            }            else            {                foreach (object item in sourceList)                {                    list.Add(item);                }            }        }        else        {            // 处理其他特殊的集合类型（如可能包含内部 _dictionary 字段的类型或泛型 ICollection<>）            var collectionType = collection.GetType();            var dictionaryType = collectionType.DeclaringType;            if (dictionaryType != null)            {                var genericArguments = dictionaryType.GetGenericArguments();                if (genericArguments.Length == 2)                {                    var keyType = genericArguments[0];                    var valueType = genericArguments[1];                    var dictionaryField = collectionType.GetField("_dictionary", BindingFlags.Instance | BindingFlags.NonPublic);                    if (dictionaryField != null && dictionaryField.GetValue(collection) is IDictionary dictionary2)                    {                        var dictionaryAsIDictionary = dictionaryField.GetValue(collection) as IDictionary;                        if (dictionaryAsIDictionary != null)                        {                            var keysProperty = dictionaryAsIDictionary.GetType().GetProperty("Keys");                            var keys = (IEnumerable)keysProperty.GetValue(dictionaryAsIDictionary, null);                            var keysList = new List<object>();                            foreach (var key in keys)                            {                                keysList.Add(key);                            }                            dictionaryAsIDictionary.Clear();                            var valueEnumerator = sourceList.GetEnumerator();                            var keyEnumerator = keysList.GetEnumerator();                            while (keyEnumerator.MoveNext() && valueEnumerator.MoveNext())                            {                                var key = keyEnumerator.Current;                                var value = valueEnumerator.Current;                                dictionaryAsIDictionary.Add(key, value);                            }                            return;                        }                    }                }            }            var iCollectionOfTInterface = collectionType.GetInterfaces().FirstOrDefault(x => x.IsGenericType && x.GetGenericTypeDefinition() == typeof(ICollection<>));            if (iCollectionOfTInterface != null)            {                var argumentType = iCollectionOfTInterface.GetGenericArguments().FirstOrDefault();                if (argumentType != null)                {                    var iCollectionOfTType = typeof(ICollection<>).MakeGenericType(argumentType);                    iCollectionOfTType.GetMethod("Clear")?.Invoke(collection, null);                    foreach (object item in sourceList)                    {                        iCollectionOfTType.GetMethod("Add")?.Invoke(collection, new object[] { item });                    }                }            }        }    }    private IEnumerable? CreateItemsSource()    {        IEnumerable? result = null;        if (ItemsSourceType != null)        {            var constructor = this.ItemsSourceType.GetConstructor(Type.EmptyTypes);            if (constructor != null)            {                result = (IEnumerable)constructor.Invoke(null);            }            else if (ItemsSourceType.IsArray)            {                result = Array.CreateInstance(this.ItemsSourceType.GetElementType(), Items.Count);            }        }        return result;    }    private object? CreateNewItem(Type type)    {        return Activator.CreateInstance(type);    }    private IEnumerable? ComputeItemsSource()    {        if (this.ItemsSource == null)        {            this.ItemsSource = this.CreateItemsSource();        }        return this.ItemsSource;    }}