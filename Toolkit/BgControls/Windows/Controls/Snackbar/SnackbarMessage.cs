namespace BgControls.Windows.Controls;/// <summary>/// 定义 <see cref="Snackbar" /> 中消息的内容。主要内容应通过标准 <see cref="ContentControl.Content" /> 属性设置./// 在允许操作的情况下，可以通过 <see cref="SnackbarMessage.ActionContent" /> 提供内容./// 为操作提供了标准按钮属性，包括 <see cref="SnackbarMessage.ActionCommand" />./// </summary>[TypeConverter(typeof(SnackbarMessageTypeConverter))][TemplatePart(Name = ActionButtonPartName, Type = typeof(ButtonBase))]public class SnackbarMessage : ContentControl{    /// <summary>    /// 操作按钮的模板部件名称.    /// </summary>    public const string ActionButtonPartName = "PART_ActionButton";    /// <summary>    /// 标识 ActionCommand 依赖属性.    /// </summary>    public static readonly DependencyProperty ActionCommandProperty =        DependencyProperty.Register("ActionCommand", typeof(ICommand), typeof(SnackbarMessage), new PropertyMetadata(null));    /// <summary>    /// 标识 ActionCommandParameter 依赖属性.    /// </summary>    public static readonly DependencyProperty ActionCommandParameterProperty =        DependencyProperty.Register("ActionCommandParameter", typeof(object), typeof(SnackbarMessage), new PropertyMetadata(null));    /// <summary>    /// 标识 ActionContent 依赖属性.    /// </summary>    public static readonly DependencyProperty ActionContentProperty =        DependencyProperty.Register("ActionContent", typeof(object), typeof(SnackbarMessage), new PropertyMetadata(null));    /// <summary>    /// 标识 ActionContentTemplate 依赖属性.    /// </summary>    public static readonly DependencyProperty ActionContentTemplateProperty =        DependencyProperty.Register("ActionContentTemplate", typeof(DataTemplate), typeof(SnackbarMessage), new PropertyMetadata(null));    /// <summary>    /// 标识 ActionContentStringFormat 依赖属性.    /// </summary>    public static readonly DependencyProperty ActionContentStringFormatProperty =        DependencyProperty.Register("ActionContentStringFormat", typeof(string), typeof(SnackbarMessage), new PropertyMetadata(null));    /// <summary>    /// 标识 ActionContentTemplateSelector 依赖属性.    /// </summary>    public static readonly DependencyProperty ActionContentTemplateSelectorProperty =        DependencyProperty.Register("ActionContentTemplateSelector", typeof(DataTemplateSelector), typeof(SnackbarMessage), new PropertyMetadata(null));    /// <summary>    /// 标识 InlineActionButtonMaxHeight 附加属性。该属性定义操作按钮保持在行内显示时的消息条最大高度.    /// </summary>    public static readonly DependencyProperty InlineActionButtonMaxHeightProperty =        DependencyProperty.RegisterAttached("InlineActionButtonMaxHeight", typeof(double), typeof(SnackbarMessage), new PropertyMetadata(55.0));    /// <summary>    /// 标识 ContentMaxHeight 附加属性。该属性定义消息内容区域的最大高度.    /// </summary>    public static readonly DependencyProperty ContentMaxHeightProperty =        DependencyProperty.RegisterAttached("ContentMaxHeight", typeof(double), typeof(SnackbarMessage), new PropertyMetadata(36.0));    /// <summary>    /// 标识操作按钮被点击时的路由事件.    /// </summary>    public static readonly RoutedEvent ActionClickEvent =        EventManager.RegisterRoutedEvent("ActionClick", RoutingStrategy.Bubble, typeof(RoutedEventHandler), typeof(SnackbarMessage));    /// <summary>    /// 内部默认资源字典.    /// </summary>    internal static readonly ResourceDictionary DefaultResources;    /// <summary>    /// Initializes static members of the <see cref="SnackbarMessage"/> class.    /// </summary>    static SnackbarMessage()    {        // 初始化默认资源.        DefaultResources = new ResourceDictionary        {            {                "SecondaryHueMidBrush",                Brushes.Transparent            },            {                "MaterialDesignSnackbarRipple",                Brushes.Transparent            },        };        // 覆盖默认样式键元数据.        DefaultStyleKeyProperty.OverrideMetadata(            typeof(SnackbarMessage),            new FrameworkPropertyMetadata(typeof(SnackbarMessage)));    }    /// <summary>    /// 模板清理操作委托.    /// </summary>    private Action templateCleanupAction = new Action(() => { });    /// <summary>    /// Gets or sets 操作命令.    /// </summary>    public ICommand? ActionCommand    {        get { return (ICommand)this.GetValue(ActionCommandProperty); }        set { this.SetValue(ActionCommandProperty, value); }    }    /// <summary>    /// Gets or sets 操作命令参数.    /// </summary>    public object? ActionCommandParameter    {        get { return this.GetValue(ActionCommandParameterProperty); }        set { this.SetValue(ActionCommandParameterProperty, value); }    }    /// <summary>    /// Gets or sets 操作按钮内容.    /// </summary>    public object? ActionContent    {        get { return this.GetValue(ActionContentProperty); }        set { this.SetValue(ActionContentProperty, value); }    }    /// <summary>    /// Gets or sets 操作按钮内容模板.    /// </summary>    public DataTemplate? ActionContentTemplate    {        get { return (DataTemplate)this.GetValue(ActionContentTemplateProperty); }        set { this.SetValue(ActionContentTemplateProperty, value); }    }    /// <summary>    /// Gets or sets 操作按钮内容字符串格式.    /// </summary>    public string? ActionContentStringFormat    {        get { return (string)this.GetValue(ActionContentStringFormatProperty); }        set { this.SetValue(ActionContentStringFormatProperty, value); }    }    /// <summary>    /// Gets or sets 操作按钮内容模板选择器.    /// </summary>    public DataTemplateSelector? ActionContentTemplateSelector    {        get { return (DataTemplateSelector)this.GetValue(ActionContentTemplateSelectorProperty); }        set { this.SetValue(ActionContentTemplateSelectorProperty, value); }    }    /// <summary>    /// 添加或移除操作按钮点击事件的处理程序.    /// </summary>    [Category("Behavior")]    public event RoutedEventHandler ActionClick    {        add { this.AddHandler(ActionClickEvent, value); }        remove { this.RemoveHandler(ActionClickEvent, value); }    }    /// <summary>    /// 引发操作点击路由事件.    /// </summary>    protected virtual void OnActionClick()    {        // 创建新的路由事件参数对象.        RoutedEventArgs actionClickEventArgs = new RoutedEventArgs(ActionClickEvent, this);        // 显式调用基类的引发事件方法.        this.RaiseEvent(actionClickEventArgs);    }    /// <summary>    /// 在应用模板时执行。用于检索模板中的子控件并绑定事件.    /// </summary>    public override void OnApplyTemplate()    {        // 执行旧模板的清理操作.        this.templateCleanupAction.Invoke();        // 检索模板中的操作按钮控件.        ButtonBase? actionButton = this.GetTemplateChild(ActionButtonPartName) as ButtonBase;        if (actionButton != null)        {            // 使用弱事件管理器绑定点击事件以防止内存泄漏.            WeakEventManager<ButtonBase, RoutedEventArgs>.AddHandler(actionButton, nameof(ButtonBase.Click), this.ButtonBaseOnClick);            // 设置新的清理操作以在下次应用模板时解除绑定.            this.templateCleanupAction = new Action(() =>            {                WeakEventManager<ButtonBase, RoutedEventArgs>.RemoveHandler(actionButton, nameof(ButtonBase.Click), this.ButtonBaseOnClick);            });        }        else        {            // 未找到控件时重置清理委托.            this.templateCleanupAction = new Action(() => { });        }        // 调用基类的模板应用逻辑.        base.OnApplyTemplate();    }    /// <summary>    /// 内部按钮点击事件处理函数.    /// </summary>    /// <param name="sender">事件源.</param>    /// <param name="routedEventArgs">事件参数.</param>    private void ButtonBaseOnClick(object? sender, RoutedEventArgs routedEventArgs)    {        // 触发类内部的操作点击逻辑.        this.OnActionClick();    }    /// <summary>    /// 设置 InlineActionButtonMaxHeight 附加属性的值.    /// </summary>    /// <param name="element">目标对象.</param>    /// <param name="value">高度值.</param>    public static void SetInlineActionButtonMaxHeight(DependencyObject element, double value)    {        ArgumentNullException.ThrowIfNull(element, nameof(element));        element.SetValue(InlineActionButtonMaxHeightProperty, value);    }    /// <summary>    /// 获取 InlineActionButtonMaxHeight 附加属性的值.    /// </summary>    /// <param name="element">目标对象.</param>    /// <returns>返回高度值.</returns>    public static double GetInlineActionButtonMaxHeight(DependencyObject element)    {        ArgumentNullException.ThrowIfNull(element, nameof(element));        return (double)element.GetValue(InlineActionButtonMaxHeightProperty);    }    /// <summary>    /// 设置 ContentMaxHeight 附加属性的值.    /// </summary>    /// <param name="element">目标对象.</param>    /// <param name="value">高度值.</param>    public static void SetContentMaxHeight(DependencyObject element, double value)    {        ArgumentNullException.ThrowIfNull(element, nameof(element));        element.SetValue(ContentMaxHeightProperty, value);    }    /// <summary>    /// 获取 ContentMaxHeight 附加属性的值.    /// </summary>    /// <param name="element">目标对象.</param>    /// <returns>返回高度值.</returns>    public static double GetContentMaxHeight(DependencyObject element)    {        ArgumentNullException.ThrowIfNull(element, nameof(element));        return (double)element.GetValue(ContentMaxHeightProperty);    }}