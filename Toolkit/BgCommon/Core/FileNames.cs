using BgCommon.Core.Models;

namespace BgCommon.Core;

/// <summary>
/// 路径管理.
/// </summary>
public static class FileNames
{
    /// <summary>
    /// Gets 程序根目录.
    /// </summary>
    public static readonly string AppRootPath = AppDomain.CurrentDomain.BaseDirectory;

    /// <summary>
    /// Gets 程序资产文件根目录.
    /// </summary>
    public static readonly string AppAssetsPath = Path.Combine(AppRootPath, "Assets");

    /// <summary>
    /// Gets 配置文件保存根目录.
    /// </summary>
    public static readonly string ConfigPath = Path.Combine(AppRootPath, "Configs");

    /// <summary>
    /// Gets 脚本文件根目录.
    /// </summary>
    public static readonly string ScriptsPath = Path.Combine(AppRootPath, "Scripts");

    /// <summary>
    /// Gets 脚本还原文件所在目录.
    /// </summary>
    public static readonly string ScriptsBuildPath = Path.Combine(ScriptsPath, "compile", "build");

    /// <summary>
    /// Gets 脚本还原文件所在目录.
    /// </summary>
    public static readonly string ScriptsRestorePath = Path.Combine(ScriptsPath, "compile", "restore");

    /// <summary>
    /// Gets 脚本引用库所在根目录.
    /// </summary>
    public static readonly string ScriptRefLibsRootPath = Path.Combine(ScriptsPath, "RefLibs");

    /// <summary>
    /// Gets 脚本引用运控库所在目录.
    /// </summary>
    public static readonly string ScriptRefMotionLibsPath = Path.Combine(ScriptRefLibsRootPath, "MotionLibs");

    /// <summary>
    /// Gets 脚本引用视觉库所在目录.
    /// </summary>
    public static readonly string ScriptRefVisionLibsPath = Path.Combine(ScriptRefLibsRootPath, "VisionLibs");

    /// <summary>
    /// Gets 程序资产图片文件根目录.
    /// </summary>
    public static readonly string AppAssetsImagePath = Path.Combine(AppAssetsPath, "Images");

    /// <summary>
    /// Gets or sets Logo 图片路径.
    /// </summary>
    public static string LogoPath { get; set; } = Path.Combine(AppAssetsImagePath, "logo.png");

    /// <summary>
    /// Gets or sets Icon 图片路径.
    /// </summary>
    public static string IconPath { get; set; } = Path.Combine(AppAssetsImagePath, "Icon.ico");

    /// <summary>
    /// Gets or sets Splash 图片路径.
    /// </summary>
    public static string SplashImagePath { get; set; } = Path.Combine(AppAssetsImagePath, "Splash.png");

    /// <summary>
    /// Gets 配置文件根目录.
    /// </summary>
    public static string AppConfigPath { get; private set; } = Path.Combine(AppRootPath, "Configs");

    /// <summary>
    /// Gets 设备文件根目录.
    /// </summary>
    public static string AppDevicePath { get; private set; } = Path.Combine(AppConfigPath, "Devices");

    /// <summary>
    /// Gets 软件配置文件路径.
    /// </summary>
    public static string SoftwareConfigPath => Path.Combine(AppConfigPath, "software.json");

    /// <summary>
    /// Gets 加密狗路径.
    /// </summary>
    public static string DogSettingPath => Path.Combine(AppConfigPath, "dogsetting.json");

    /// <summary>
    /// Gets 软件出厂设置配置文件路径.
    /// </summary>
    public static string FactorySetPath => Path.Combine(AppConfigPath, "FactorySet.dat");

    /// <summary>
    /// Gets a value indicating whether 是否为本地路径.
    /// </summary>
    public static bool IsLocal { get; private set; } = true;

    /// <summary>
    /// Gets 项目文件根目录.
    /// </summary>
    public static string ProjectPath { get; private set; } = Path.Combine(AppRootPath, "DataDir", "Projects");

    /// <summary>
    /// Gets 项目运行结果根目录.
    /// </summary>
    public static string ProjectResultPath { get; private set; } = Path.Combine(AppRootPath, "DataDir", "Results");

    /// <summary>
    /// Gets 日志文件根目录.
    /// </summary>
    public static string LogPath { get; } = Path.Combine(AppRootPath, "Logs");

    /// <summary>
    /// 设置项目设备路径.
    /// </summary>
    /// <param name="machine">机器项目路径设置.</param>
    public static void SetProjectPath(MachineSetting? machine)
    {
        if (machine != null)
        {
            IsLocal = machine.IsLocal;
            AppConfigPath = machine.ConfigDirectory;
            ProjectPath = machine.ProjectDirectory;
            ProjectResultPath = machine.ProjectResultDirectory;
        }
    }

    /// <summary>
    /// 获取指定类型文件所在根目录.
    /// </summary>
    /// <param name="fileType">文件类型.</param>
    /// <returns>返回指定类型文件所在根目录.</returns>
    private static string ToRootDir(FileType fileType)
    {
        string dir = fileType switch
        {
            FileType.Project => ProjectPath,
            FileType.ProjectResult => ProjectResultPath,
            _ => string.Empty,
        };

        if (!string.IsNullOrEmpty(dir) && !Directory.Exists(dir))
        {
            _ = Directory.CreateDirectory(dir);
        }

        return dir;
    }

    /// <summary>
    /// 获取指定项目文件所在目录.
    /// </summary>
    /// <param name="projectName">项目名称.</param>
    /// <param name="fileType">文件类型.</param>
    /// <returns>返回指定项目文件所在目录.</returns>
    public static string ToDirectory(string projectName, FileType fileType)
    {
        return ToDirectory(projectName, ToRootDir(fileType));
    }

    /// <summary>
    /// 获取指定项目文件所在目录.
    /// </summary>
    /// <param name="projectName">项目名称.</param>
    /// <param name="rootDir">项目根目录.</param>
    /// <returns>指定项目文件所在目录.</returns>
    public static string ToDirectory(string projectName, string rootDir)
    {
        string prjDir = Path.Combine(rootDir, projectName);

        if (!Directory.Exists(prjDir))
        {
            _ = Directory.CreateDirectory(prjDir);
        }

        return prjDir;
    }

    /// <summary>
    /// 获取指定项目文件全路径.
    /// </summary>
    /// <param name="projectName">项目名称.</param>
    /// <param name="fileType">文件类型.</param>
    /// <returns>返回指定项目文件全路径.</returns>
    public static string ToFilePath(string projectName, FileType fileType)
    {
        return Path.Combine(ToDirectory(projectName, fileType), $"{projectName}{((ExtType)fileType).ToExtensionString()}");
    }

    /// <summary>
    /// 获取指定项目文件全路径.
    /// </summary>
    /// <param name="projectName">项目名称.</param>
    /// <param name="rootDir">项目文件夹所在根目录.</param>
    /// <param name="fileType">文件类型.</param>
    /// <returns>返回指定项目文件全路径.</returns>
    public static string ToFilePath(string projectName, string rootDir, FileType fileType)
    {
        return Path.Combine(ToDirectory(rootDir, projectName), $"{projectName}{((ExtType)fileType).ToExtensionString()}");
    }

    /// <summary>
    /// 获取项目文件列表列表.
    /// </summary>
    /// <param name="extType">文件扩展类型.</param>
    /// <param name="rootDir">项目文件根目录.</param>
    /// <param name="searchPattern">用于与路径中文件名称进行匹配的搜索字符串。此参数可以包含有效的文本路径和通配符（* 和？）字符的组合，但不支持正则表达式.</param>
    /// <returns>项目文件列表列表.</returns>
    public static List<string> GetFiles(ExtType extType, string? rootDir, string? searchPattern = null)
    {
        if (string.IsNullOrEmpty(rootDir))
        {
            throw new DirectoryNotFoundException("The incoming root path of the folder cannot be empty");
        }

        string ext = extType.ToExtensionString();
        List<string> list = new List<string>();
        if (Directory.Exists(rootDir))
        {
            string searchPattern1 = $"*{ext}";
            if (!string.IsNullOrEmpty(searchPattern))
            {
                searchPattern1 = $"*{searchPattern}*{ext}";
            }

            string[] files = Directory.GetFiles(rootDir, searchPattern1, SearchOption.AllDirectories);
            list.AddRange(files);
        }

        return list;
    }
}