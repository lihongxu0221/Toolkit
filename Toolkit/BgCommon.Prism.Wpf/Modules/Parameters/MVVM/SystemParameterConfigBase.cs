using BgCommon.Prism.Wpf.Modules.Parameters.Models;using BgControls.Windows.Controls.PropertyGrid;using Prism.Common;namespace BgCommon.Prism.Wpf.Modules.Parameters;/// <summary>/// 系统参数配置MVVM基类./// </summary>public abstract partial class SystemParameterConfigBase :    NavigableDialogViewModel{    private readonly IAuthService authService;    private readonly ILoginService loginService;    private readonly IParameterActionService parameterActionService;    private volatile bool initialized;    /// <summary>    /// Gets a value indicating whether gets 是否可加载配置的参数.    /// </summary>    protected virtual bool IsLoadParametersEnabled =>        !string.IsNullOrEmpty(ModuleCode) &&        !string.IsNullOrEmpty(PermissionCode) &&        ParamRequest != null;    /// <summary>    /// Gets 模块编码.    /// </summary>    public abstract string ModuleCode { get; }    /// <summary>    /// Gets 配置按钮权限编码.    /// </summary>    public abstract string PermissionCode { get; }    /// <summary>    /// Gets 查询，显示，配置 参数列表.    /// </summary>    public abstract ParameterQueryRequest ParamRequest { get; }    /// <summary>    /// 是否允许管理配置参数.    /// </summary>    [ObservableProperty]    private bool allowConfigParameter = false;    /// <summary>    /// 自定义属性列表项目.    /// </summary>    [ObservableProperty]    private PropertyItemFilterCallback? filterAdvance;    /// <summary>    /// 获取到的参数分组绑定列表.    /// </summary>    [ObservableProperty]    private ObservableDictionary<string, ObservableRangeCollection<SystemParameterDisplay>> parameters = new ObservableDictionary<string, ObservableRangeCollection<SystemParameterDisplay>>();    /// <summary>    /// 选择的ProperyItem描述.    /// </summary>    [ObservableProperty]    private string selectedPropertyDescription = string.Empty;    /// <summary>    /// 选择的ProperyItem显示值.    /// </summary>    [ObservableProperty]    private string selectedPropertyDisplayName = string.Empty;    /// <summary>    /// Initializes a new instance of the <see cref="SystemParameterConfigBase"/> class.    /// </summary>    /// <param name="container">Ioc 容器.</param>    protected SystemParameterConfigBase(IContainerExtension container)        : base(container)    {        this.authService = this.Container.Resolve<IAuthService>();        this.loginService = this.Container.Resolve<ILoginService>();        this.parameterActionService = this.Container.Resolve<IParameterActionService>();        this.FilterAdvance = new PropertyItemFilterCallback(this.OnPropertyItemFactoryCallback);    }    /// <summary>    /// Gets 权限校验服务.    /// </summary>    protected IAuthService AuthService => authService;    /// <summary>    /// Gets 登陆与缓存服务.    /// </summary>    public ILoginService LoginService => loginService;    /// <summary>    /// Gets 参数管理服务.    /// </summary>    protected IParameterActionService ParameterActionService => parameterActionService;    /// <summary>    /// 参数配置完毕.    /// </summary>    /// <param name="successfull">是否成功配置.</param>    protected virtual void OnParameterConfigurationCompleted(bool successfull)    {    }    /// <summary>    /// 自定义属性过滤和赋值方法.    /// </summary>    /// <param name="propertyItem">要过滤的属性.</param>    /// <param name="displayList">读取到的参数配置.</param>    /// <returns>null: 使用默认逻辑. true，false: 直接返回结果.</returns>    protected virtual bool? OnCustmerFilterAdvance(PropertyItem propertyItem, ObservableRangeCollection<SystemParameterDisplay>? displayList)    {        return null;    }    /// <summary>    /// 显示属性过滤.    /// </summary>    /// <param name="selectedObjectName">根节点所属属性名称.</param>    /// <param name="propertyItem">要过滤的属性.</param>    /// <returns>如果该属性应该显示，则返回 true；否则返回 false.</returns>    private bool OnPropertyItemFactoryCallback(string selectedObjectName, PropertyItem propertyItem)    {        string propertyName = propertyItem.PropertyName;        if (this.Parameters.TryGetValue(selectedObjectName, out ObservableRangeCollection<SystemParameterDisplay>? displayList))        {            if (displayList == null || displayList.Count == 0)            {                return true;            }            if (propertyItem.IsReadOnly)            {                return true;            }            // 调用自定义过滤方法，如果有非空值返回，则直接返回结果.            var custmerRet = this.OnCustmerFilterAdvance(propertyItem, displayList);            if (custmerRet.HasValue)            {                return custmerRet.Value;            }            // 判断是不是类中类.            if (propertyItem.IsExpandable)            {                var list = displayList.Where(d => d.Code.Contains($".{propertyName}."));                if (list.Any(d => d.IsEnable))                {                    propertyItem.IsReadOnly = !list.Any(d => d.IsEditable);                    return true;                }            }            else            {                // 自定义过滤返回为null，则使用默认的过滤逻辑和赋值逻辑.                SystemParameterDisplay? display = displayList?.FirstOrDefault(d => d.Code.EndsWith($".{propertyName}", StringComparison.CurrentCulture));                if (display != null)                {                    propertyItem.Category = display.Category;                    propertyItem.Description = display.Description ?? string.Empty;                    propertyItem.DisplayName = display.Name;                    propertyItem.IsReadOnly = !display.IsEditable;                    if (propertyItem.PropertyType.IsNumberType())                    {                        propertyItem.DecimalPlaces = display.DecimalPlaces;                        propertyItem.Maximum = display.Maximum;                        propertyItem.Minimum = display.Minimum;                        propertyItem.Increment = display.Increment;                    }                    return true;                }            }        }        return false;    }    /// <summary>    /// 清除参数.    /// </summary>    protected void OnParametersClear()    {        foreach (KeyValuePair<string, ObservableRangeCollection<SystemParameterDisplay>> dicItem in Parameters)        {            foreach (SystemParameterDisplay valueDisplay in dicItem.Value)            {                // valueDisplay.PropertyChanged -= Parameter_PropertyChanged;                WeakEventManager<ObservableObject, PropertyChangedEventArgs>.RemoveHandler(                    valueDisplay,                    nameof(valueDisplay.PropertyChanged),                    Parameter_PropertyChanged);            }            dicItem.Value.Clear();        }        // 初始化参数分组键.        if (this.ParamRequest != null)        {            foreach (var nodeItem in this.ParamRequest.RootNodes)            {                if (!this.Parameters.ContainsKey(nodeItem.PropetyName))                {                    this.Parameters.Add(nodeItem.PropetyName, new ObservableRangeCollection<SystemParameterDisplay>());                }            }        }        this.initialized = false;    }    /// <summary>    /// 加载当前已经配置好的参数.    /// </summary>    /// <returns>Task.</returns>    protected async Task LoadParametersAsync()    {        ResponseResult<VisibleParameterQueryResult> response =            await parameterActionService.GetVisibleParametersAsync(ModuleCode, ParamRequest);        if (!response.Success)        {            if (response.Result != null && response.Result.Failed.Any(t => t != null))            {                string errorMsg = string.Join(Environment.NewLine, response.Result!.Failed.Select(f => f.Reason));                LogRun.Error(errorMsg);            }            _ = await this.ErrorAsync(response.Message);        }        UIService.RunOnUIThread(() =>        {            try            {                this.OnParametersClear();                if (response.Result != null)                {                    List<SystemParameterDisplay> allDisplays = response.Result.Parameters.ToList();                    var groupDisplays = allDisplays.GroupBy(d => d.RootName).ToDictionary(d => d.Key, d => d.ToList());                    foreach (KeyValuePair<string, List<SystemParameterDisplay>> groupDisplay in groupDisplays)                    {                        string key = groupDisplay.Key;                        if (!this.Parameters.TryGetValue(key, out var value))                        {                            value = new ObservableRangeCollection<SystemParameterDisplay>();                            this.Parameters.Add(key, value);                        }                        value.ReplaceRange(groupDisplay.Value.ToList());                        foreach (SystemParameterDisplay valueDisplay in value)                        {                            // valueDisplay.PropertyChanged += Parameter_PropertyChanged;                            WeakEventManager<ObservableObject, PropertyChangedEventArgs>.AddHandler(                                valueDisplay,                                nameof(valueDisplay.PropertyChanged),                                this.Parameter_PropertyChanged);                        }                    }                    groupDisplays.Clear();                }            }            catch (Exception ex)            {                _ = this.Error(ex.ToString());            }        });    }    /// <summary>    /// 校验当前登陆账号是否具有参数配置权限.    /// </summary>    /// <returns>Task.</returns>    protected async Task VerifyPermissionAsync()    {        ResponseResult response = await this.authService.VerifyPermissionAsync(loginService.CurrentUser!.Id, PermissionCode);        this.AllowConfigParameter = response.Success;    }    /// <inheritdoc/>    protected override Task OnLoadedAsync(object? parameter)    {        return base.OnLoadedAsync(parameter);    }    /// <inheritdoc/>    protected override async Task OnUnloadAsync(object? parameter)    {        await UIService.RunOnUIThreadAsync(() =>         {             this.OnParametersClear();             this.Parameters.Clear();         });    }    /// <inheritdoc/>    protected override async Task OnBeforeInitializedAsync(IParameters parameters)    {        if (!this.initialized)        {            if (this.IsLoadParametersEnabled)            {                await this.LoadParametersAsync();                await this.VerifyPermissionAsync();            }            this.initialized = true;        }    }    [RelayCommand]    private async Task OnConfigParameter()    {        if (this.IsLoadParametersEnabled)        {            ResponseResult response = await parameterActionService.ConfigureAsync(ModuleCode, ParamRequest);            if (response.Success)            {                await this.LoadParametersAsync();                if (this.ParamRequest != null)                {                    foreach (var nodeItem in this.ParamRequest.RootNodes)                    {                        this.OnPropertyChanged(nodeItem.PropetyName);                    }                }                LogRun.Info(response.Message);                this.OnParameterConfigurationCompleted(true);                _ = await this.InfoAsync(response.Message);            }            else            {                LogRun.Error(response.Message);                this.OnParameterConfigurationCompleted(false);                _ = await this.ErrorAsync(response.Message);            }        }    }    [RelayCommand]    private async Task OnSelectedPropertyChanged(RoutedPropertyChangedEventArgs<PropertyItemBase>? e)    {        await this.UIService.RunOnUIThreadAsync(async () =>        {            if (e != null)            {                this.SelectedPropertyDisplayName = e.NewValue?.DisplayName ?? string.Empty;                this.SelectedPropertyDescription = e.NewValue?.Description ?? string.Empty;            }        });    }    private void Parameter_PropertyChanged(object? sender, PropertyChangedEventArgs e)    {        if (sender is SystemParameterDisplay parameter)        {            // 参数为可编辑            if (parameter.IsEditable && e.PropertyName == nameof(parameter.Value))            {                var response = parameterActionService.TryUpdateTo(ParamRequest, parameter);                if (!response.Success)                {                    _ = this.ErrorAsync(response.Message);                }            }        }    }}