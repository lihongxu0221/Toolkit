using BgCommon.Prism.Wpf.Modules.Parameters.Models;using BgControls.Windows.Controls.PropertyGrid;namespace BgCommon.Prism.Wpf.Modules.Parameters.Reflection;/// <summary>/// 表示属性树中的一个节点./// 它可以代表一个或多个实例上的同一个属性./// </summary>public partial class PropertyNode : ObservableObject{    /// <summary>    /// 属性解析器.    /// </summary>    public readonly static PropertyResolver Resolver = new PropertyResolver();    private bool isInitialize;    private bool isUpdatingCheckState;    /// <summary>    /// Gets or sets 此属性在目标实例上的值.    /// 如果代表多个实例，获取时：如果所有实例的值相同，则返回该值；否则返回 null.    /// 设置时：会尝试将此值设置到所有目标实例上.    /// </summary>    [ObservableProperty]    private object? propertyValue = null;    /// <summary>    /// 小数位数.    /// </summary>    [ObservableProperty]    private int? decimalPlaces = 0;    /// <summary>    /// 最小值.    /// </summary>    [ObservableProperty]    private double? minimum = null;    /// <summary>    /// 最大值.    /// </summary>    [ObservableProperty]    private double? maximum = null;    /// <summary>    /// 步长.    /// </summary>    [ObservableProperty]    private double? increment = null;    /// <summary>    /// 是否被勾选.    /// </summary>    [ObservableProperty]    private bool? isEnable = false;    /// <summary>    /// 是否被选中.    /// </summary>    [ObservableProperty]    private bool isSelected = false;    /// <summary>    /// 字段类型.    /// </summary>    [ObservableProperty]    private EditorTypeCode type = EditorTypeCode.PlainText;    /// <summary>    /// Initializes a new instance of the <see cref="PropertyNode"/> class.    /// </summary>    /// <param name="component">属性所属对象实例.</param>    /// <param name="descriptor">属性.</param>    /// <param name="value">属性值.</param>    /// <param name="parent">属性所属对象节点.</param>    public PropertyNode(        object component,        PropertyDescriptor descriptor,        object? value = null,        PropertyNode? parent = null)    {        this.isInitialize = false;        this.Children = new ObservableRangeCollection<PropertyNode>();        this.Component = component;        this.Descriptor = descriptor;        this.Type = Resolver.ResolveTypeCode(descriptor.PropertyType);        this.PropertyName = descriptor.Name;        this.PropertyValue = value ?? GetPropertyValue(descriptor, component);        this.Category = Resolver.ResolveCategory(descriptor);        this.Description = Resolver.ResolveDescription(descriptor);        this.DisplayName = Resolver.ResolveDisplayName(descriptor);        this.DefaultValue = Resolver.ResolveDefaultValue(descriptor);        this.IsReadOnly = Resolver.ResolveIsReadOnly(descriptor);        this.IsEnable = true;        this.Parent = parent;        this.DecimalPlaces = null;        this.Minimum = null;        this.Maximum = null;        this.Increment = null;        if (this.PropertyType.IsNumberType())        {            if (this.PropertyType.IsFloatType(false))            {                this.DecimalPlaces = 2;                this.Increment = 0.01;            }            else            {                this.DecimalPlaces = 0;                this.Increment = 1;            }        }        this.isInitialize = true;    }    /// <summary>    /// Gets 此节点所代表的所有目标对象实例或列表实例.    /// </summary>    public object Component { get; }    /// <summary>    /// Gets 描述此属性的元数据.    /// </summary>    public PropertyDescriptor Descriptor { get; }    /// <summary>    /// Gets 属性类型.    /// </summary>    public Type PropertyType => this.Descriptor.PropertyType;    /// <summary>    /// Gets 父属性节点 (如果有).    /// </summary>    public PropertyNode? Parent { get; }    /// <summary>    /// Gets 子属性节点 (如果此属性是复杂类型).    /// </summary>    public ObservableRangeCollection<PropertyNode> Children { get; }    /// <summary>    /// Gets 属性的名称.    /// </summary>    public string PropertyName { get; } = string.Empty;    /// <summary>    /// Gets 属性的显示名称 (可以从 DisplayNameAttribute 获取，否则为属性名).    /// </summary>    public string DisplayName { get; } = string.Empty;    /// <summary>    /// Gets 属性分类.(可以从 CategoryAttribute 获取，否则为空).    /// </summary>    public string Category { get; } = string.Empty;    /// <summary>    /// Gets 属性描述.(可以从 DescriptionAttribute 获取，否则为空).    /// </summary>    public string Description { get; } = string.Empty;    /// <summary>    /// Gets 属性描述.(可以从 DescriptionAttribute 获取，否则为空).    /// </summary>    public object? DefaultValue { get; }    /// <summary>    /// Gets a value indicating whether gets 此属性是否只读.    /// </summary>    public bool IsReadOnly { get; }    /// <summary>    /// Gets 获取根节点属性名.    /// </summary>    public string RootName    {        get        {            if (this.Parent == null)            {                return this.PropertyName;            }            return this.Parent.RootName;        }    }    /// <summary>    /// Gets 获取根节点属性DisplayName.    /// </summary>    public string RootDisplayName    {        get        {            if (this.Parent == null)            {                return this.DisplayName;            }            return this.Parent.RootDisplayName;        }    }    /// <summary>    /// Gets 属性的完整路径名称 (例如 "Position.X").    /// </summary>    public string FullName    {        get        {            if (this.Parent == null || string.IsNullOrEmpty(this.Parent.FullName))            {                return PropertyName;            }            return $"{this.Parent.FullName}.{PropertyName}";        }    }    /// <summary>    /// Gets 属性的完整路径显示名称 (例如 "Position.X").    /// </summary>    public string FullDisplayName    {        get        {            if (this.Parent == null || string.IsNullOrEmpty(this.Parent.FullDisplayName))            {                return DisplayName;            }            return $"{this.Parent.FullDisplayName}.{DisplayName}";        }    }    /// <summary>    /// 选中状态发生变化.    /// </summary>    public event EventHandler? CheckStatusChanged;    partial void OnPropertyValueChanged(object? oldValue, object? newValue)    {        if (!this.isInitialize ||            this.Descriptor == null ||            this.Component == null ||            this.IsReadOnly ||            ReferenceEquals(oldValue, newValue))        {            return;        }        // 只支持泛型集合,其他不支持        if (this.Component is IList list)        {            try            {                // 遍历集合中的每一个元素                for (int i = 0; i < list.Count; i++)                {                    object? item = list[i];                    if (item == null)                    {                        continue;                    }                    if (this.Descriptor.PropertyType?.IsAssignableFrom(item.GetType()) ?? false)                    {                        try                        {                            object? value = newValue;                            if (newValue is Array array && array.Length >= (i + 1))                            {                                value = array.GetValue(i);                            }                            this.Descriptor.SetValue(item, value);                        }                        catch (Exception _)                        {                            continue;                        }                    }                }            }            catch            {                // 转换或设置失败，回滚值                this.PropertyValue = oldValue;            }        }        else        {            try            {                // 类型转换                var convertedValue = Convert.ChangeType(newValue, this.Descriptor.PropertyType);                this.Descriptor.SetValue(this.Component, convertedValue);            }            catch            {                // 转换失败或设置失败，可以记录日志                // 最好是回滚值                this.PropertyValue = oldValue;            }        }    }    partial void OnIsEnableChanged(bool? oldValue, bool? newValue)    {        if (this.isUpdatingCheckState)        {            return;        }        this.isUpdatingCheckState = true;        // 向下更新子节点        this.UpdateChildrenCheckState(newValue);        // 向上更新父节点        this.UpdateParentCheckState();        // 只触发顶级节点的CheckStatusChanged事件        this.OnCheckStatusChanged(this);        this.isUpdatingCheckState = false;    }    private void OnCheckStatusChanged(object sender)    {        if (Parent != null)        {            Parent.OnCheckStatusChanged(sender);        }        else        {            if (CheckStatusChanged != null)            {                CheckStatusChanged.Invoke(sender, EventArgs.Empty);            }        }    }    private void UpdateChildrenCheckState(bool? state)    {        if (state.HasValue)        {            foreach (PropertyNode child in Children)            {                child.isUpdatingCheckState = true;                child.IsEnable = state;                child.isUpdatingCheckState = false;            }        }    }    private void UpdateParentCheckState()    {        if (Parent != null)        {            if (Parent.isUpdatingCheckState)            {                return;            }            Parent.isUpdatingCheckState = true;            bool allChecked = Parent.Children.All(c => c.IsEnable == true);            bool allUnchecked = Parent.Children.All(c => c.IsEnable == false);            if (allChecked)            {                Parent.IsEnable = true;            }            else if (allUnchecked)            {                Parent.IsEnable = false;            }            else            {                Parent.IsEnable = null;            }            Parent.UpdateParentCheckState();            Parent.isUpdatingCheckState = false;        }    }    /// <summary>    /// 从整个属性树的根节点开始，查找 FullName 匹配的节点（需先获取根节点）.    /// </summary>    /// <param name="fullName">要查找的节点 FullName.</param>    /// <returns>找到则返回 PropertyNode，未找到则返回 null.</returns>    public PropertyNode? FindNode(string fullName)    {        // 1. 先找到当前节点所在树的根节点（向上追溯至无 Parent 的节点）        PropertyNode rootNode = this;        while (rootNode.Parent != null)        {            rootNode = rootNode.Parent;        }        // 2. 从根节点开始，包含根节点本身在内递归查找        return rootNode.RecurseFindNodeIncludeSelf(fullName);    }    /// <summary>    /// 递归查找节点（包含当前节点本身）.    /// </summary>    /// <param name="fullName">全路径.</param>    /// <returns>返回查找到的节点.</returns>    private PropertyNode? RecurseFindNodeIncludeSelf(string fullName)    {        // 1. 先检查当前节点是否匹配        if (string.Equals(FullName, fullName, StringComparison.Ordinal))        {            return this;        }        // 2. 递归查找当前节点的所有子节点        foreach (PropertyNode child in this.Children)        {            PropertyNode? foundNode = child.RecurseFindNodeIncludeSelf(fullName);            if (foundNode != null)            {                return foundNode;            }        }        return null;    }    /// <summary>    /// 获取属性描述符在指定所有者对象上的值.    /// 如果所有者对象是列表类型，则返回列表中所有元素的该属性值数组（仅包含非空值）.    /// </summary>    /// <param name="descriptor">属性描述符实例.</param>    /// <param name="owner">所有者对象实例.</param>    /// <returns>返回属性值.如果是列表对象，返回属性值数组；如果是单个对象，返回对应的属性值；如果没有非空值则返回null.</returns>    public object? GetPropertyValue(PropertyDescriptor descriptor, object owner)    {        if (owner is IList targetList)        {            List<object?> values = new List<object?>();            if (targetList != null)            {                for (int i = 0; i < targetList.Count; i++)                {                    object? value = null;                    if (targetList[i] != null)                    {                        value = descriptor.GetValue(targetList[i]);                    }                    values.Add(value);                }            }            return values.Any(so => so != null) ? values.ToArray() : null;        }        else        {            return descriptor.GetValue(owner);        }    }    public override string ToString()    {        return $"{this.FullName}（{this.DisplayName}) = {this.PropertyValue}";    }    /// <summary>    /// 参数存储实例转换为展示参数实例.    /// </summary>    /// <param name="node">参数节点实例.</param>    public static explicit operator SystemParameterDisplay?(PropertyNode node)    {        if (node.Descriptor != null && node.Children.Count == 0)        {            string plainText = string.Empty;            Resolver.TryConvertFrom(node.PropertyType, node.PropertyValue, out plainText);            var display = new SystemParameterDisplay();            display.Id = 0;            display.Code = node.FullName;            display.Name = node.DisplayName;            display.Value = plainText;            display.Descriptor = node.Descriptor;            // display.ValueType = node.Type;            // display.MinVisibleRole = currentModule?.SystemRole ?? SystemRole.Operator;            // display.MinEditableRole = currentModule?.SystemRole ?? SystemRole.Operator;            display.DecimalPlaces = node.DecimalPlaces;            display.Minimum = node.Minimum;            display.Maximum = node.Maximum;            display.Increment = node.Increment;            // display.Module = currentModule;            // display.ModuleId = currentModule?.Id ?? 0;            // display.CreatedBy = userName;            // display.CreatedAt = DateTime.Now;            // display.ModifiedBy = userName;            // display.LastModifiedAt = DateTime.Now;            display.IsEnable = node.IsEnable ?? false;            display.IsEditable = !node.IsReadOnly;            display.RootName = node.RootName;            display.RootDisplayName = node.RootDisplayName;            display.ParentNode = node.Parent?.FullName ?? string.Empty;            display.ParentDisplayName = node.Parent?.FullDisplayName ?? display.ParentNode;            display.Category = node.Category;            display.Description = node.Description;            display.Constraints = new ObservableRangeCollection<ParameterConstraint>();            AddConstraint(display, ConstraintType.DecimalPlaces, display.DecimalPlaces);            AddConstraint(display, ConstraintType.Minimum, display.Minimum);            AddConstraint(display, ConstraintType.Maximum, display.Maximum);            AddConstraint(display, ConstraintType.Increment, display.Increment);            return display;        }        return null;        void AddConstraint<T>(SystemParameterDisplay display, ConstraintType constraintType, T? value)        {            if (value != null)            {                display.Constraints.Add(new ParameterConstraint()                {                    Id = 0,                    ParameterId = display.Id,                    Type = constraintType,                    Value = value.ToString() ?? string.Empty,                    IsEnable = true,                });            }        }    }}/// <summary>/// PropertyNode 扩展方法./// </summary>public static partial class Extension{    /// <summary>    /// 【模式二：独立树】    /// 为一个或多个对象实例，构建一个【独立的】属性树列表。    /// 列表中的每一项，都对应一个输入实例的完整属性树.    /// </summary>    /// <param name="request">要生成属性树的对象实例.</param>    /// <returns>一个列表，其中每个元素都是一个对应输入实例的、完整的属性树（根节点列表）.</returns>    public static List<PropertyNode> BuildTrees(this ParameterQueryRequest request)    {        if (request == null || request.RootNodes.Count == 0)        {            return new List<PropertyNode>();        }        var allTrees = new List<PropertyNode>();        foreach (PropertyNodeItem nodeItem in request.RootNodes)        {            if (nodeItem.PropetyValue == null || string.IsNullOrEmpty(nodeItem.PropetyName))            {                continue;            }            PropertyDescriptor? descriptor = TypeDescriptor.GetProperties(request.RootComponent.GetType())                .OfType<PropertyDescriptor>()                .FirstOrDefault(p => p.Name == nodeItem.PropetyName);            if (descriptor != null)            {                if (!descriptor.IsBrowsable || descriptor.IsReadOnly || descriptor.PropertyType.IsNotPublic)                {                    continue;                }                PropertyNode rootNode = new PropertyNode(request.RootComponent, descriptor, nodeItem.PropetyValue);                // 复杂类型时，继续向下递归获取属性节点.                if (!rootNode.PropertyType.IsSimpleType())                {                    rootNode.BuildChildren(new HashSet<object>());                }                allTrees.Add(rootNode);            }        }        return allTrees;    }    /// <summary>    /// 递归地为单个对象构建属性节点.    /// </summary>    /// <param name="parentNode">父节点.</param>    /// <param name="visited">防止重复调用.</param>    public static void BuildChildren(this PropertyNode parentNode, HashSet<object> visited)    {        var owner = parentNode.PropertyValue;        if (owner == null || visited.Contains(owner)) // 防止循环引用        {            return;        }        Type ownerType = parentNode.PropertyType;        if (ownerType.IsSimpleType())        {            return;        }        _ = visited.Add(owner);        Type? type = null;        var nodes = new List<PropertyNode>();        if (owner is IList list && list.Count > 0)        {            // 处理泛型类型 IList<T>            type = list.Cast<object>().FirstOrDefault(t => t != null)?.GetType();        }        else if (owner is Array array && array.Length > 0)        {            type = ownerType.GetElementType();        }        else        {            type = ownerType;        }        if (type == null)        {            return;        }        // 获取当前对象的所有属性        var properties = TypeDescriptor.GetProperties(type).OfType<PropertyDescriptor>();        foreach (PropertyDescriptor descriptor in properties)        {            if (!descriptor.IsBrowsable || descriptor.IsReadOnly || descriptor.PropertyType.IsNotPublic)            {                continue;            }            var node = new PropertyNode(owner, descriptor, null, parentNode);            if (!node.PropertyType.IsSimpleType() && node.PropertyValue != null)            {                // 只要属性是复杂类型，就统一进行递归！                // 注意：这里需要传递 node 给递归函数，因为它的 Value 包含了子对象/子对象集合                node.BuildChildren(visited);            }            nodes.Add(node);        }        parentNode.Children.AddRange(nodes);        // _ = visited.Remove(target);    }    /// <summary>    /// 递归为treeNodes生成SystemParameterDisplay列表.    /// </summary>    /// <param name="treeNodes">属性树列表.</param>    /// <param name="currentModule">所属模块.</param>    /// <param name="currentUser">操作用户.</param>    /// <returns>返回 SystemParameterDisplay列表.</returns>    public static List<SystemParameterDisplay> ToDisplays(this IEnumerable<PropertyNode> treeNodes, ModuleInfo? currentModule, UserInfo? currentUser)    {        var list = new List<SystemParameterDisplay>();        foreach (PropertyNode node in treeNodes)        {            if (node.Children != null && node.Children.Count > 0)            {                List<SystemParameterDisplay> childList = node.Children.ToDisplays(currentModule, currentUser);                if (childList.Count > 0)                {                    list.AddRange(childList);                }            }            else            {                var display = (SystemParameterDisplay?)node;                if (display != null)                {                    display.MinVisibleRole = currentModule?.SystemRole ?? SystemRole.Operator;                    display.MinEditableRole = currentModule?.SystemRole ?? SystemRole.Operator;                    display.Module = currentModule;                    display.ModuleId = currentModule?.Id ?? 0;                    string userName = currentUser?.UserName ?? "System";                    display.CreatedBy = userName;                    display.CreatedAt = DateTime.Now;                    display.ModifiedBy = userName;                    display.LastModifiedAt = DateTime.Now;                    // display.IsEnable = false;                    list.Add(display);                }            }        }        return list;    }}