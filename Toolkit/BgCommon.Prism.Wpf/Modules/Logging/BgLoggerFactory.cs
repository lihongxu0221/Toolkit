using BgCommon.Prism.Wpf.Modules.Logging.Models;using BgCommon.Prism.Wpf.Modules.Logging.Services;using BgCommon.Prism.Wpf.Modules.Logging.Services.Implementation;using BgCommon.Prism.Wpf.Modules.Logging.ViewModels;using BgCommon.Prism.Wpf.Modules.Logging.Views;using Microsoft.Extensions.Configuration;using NLog.Extensions.Logging;using Microsoft.Extensions.DependencyInjection;namespace BgCommon.Prism.Wpf.Modules.Logging;/// <summary>/// BgLogger 工厂类，负责注册依赖、配置日志、初始化数据库等./// </summary>public static class BgLoggerFactory{    /// <summary>    /// 注册依赖类型和服务到容器.<br/>    /// Prism 应用程序的 RegisterTypes 方法通常在应用程序启动时调用，<br/>    /// </summary>    /// <param name="containerRegistry">容器注册器.</param>    public static void Register(IContainerRegistry containerRegistry)    {        // 1. 加载 AppSettings 配置        IConfigurationBuilder builder = new ConfigurationBuilder().SetBasePath(AppContext.BaseDirectory)                                                                  .AddJsonFile("bglogger.appsettings.json", optional: false, reloadOnChange: true);        IConfiguration configuration = builder.Build();        var appSettings = new AppSettings();        configuration.GetSection("AppSettings").Bind(appSettings);        _ = containerRegistry.RegisterInstance(appSettings); // 以单例方式注册        _ = containerRegistry.RegisterInstance(configuration);        // 2.配置 NLog 日志        _ = LogManager.LogFactory.Setup().SetupExtensions(ext =>         {             // <--- 2b. 在实例上注册别名             _ = ext.RegisterTarget<NLog.Targets.Wrappers.SplitGroupTarget>("Splitter");         });        LogManager.Configuration = new NLogLoggingConfiguration(configuration.GetSection("NLog"));        // 3. 注册 Microsoft.Extensions.Logging 日志服务        ServiceCollection serviceCollection = new();        _ = serviceCollection.AddLogging(loggingBuilder =>        {            _ = loggingBuilder.ClearProviders();            _ = loggingBuilder.SetMinimumLevel(Microsoft.Extensions.Logging.LogLevel.Trace);            // 注意：现在 AddNLog() 会使用我们刚刚配置好的全局 LogManager            // 或传递 NLog.config 路径或 NLogConfiguration 对象            _ = loggingBuilder.AddNLog(configuration);        });        ServiceProvider serviceProvider = serviceCollection.BuildServiceProvider();        ILoggerFactory factory = serviceProvider.GetRequiredService<ILoggerFactory>();        _ = containerRegistry.RegisterInstance(factory); // 用于 ILogger<T>        // 4. 直接获取 NLog 的 ILogger 实例        _ = containerRegistry.RegisterInstance(LogManager.GetLogger("Default")); // 默认 logger        // 5. 注册自定义服务（如日志配置、数据库服务）        _ = containerRegistry.RegisterSingleton<ILoggingConfigurationService, LoggingConfigurationService>();        _ = containerRegistry.RegisterSingleton<IDatabaseService, SqliteDatabaseService>();        // 6. 注册用于导航的视图（如主视图、历史日志视图）LoggerDialogAutoSizeWindow        containerRegistry.RegisterDialogWindow<LoggerDialogWindow>(nameof(LoggerDialogWindow));        containerRegistry.RegisterDialogWindow<LoggerDialogAutoSizeWindow>(nameof(LoggerDialogAutoSizeWindow));        containerRegistry.RegisterDialog<LoggerMainView>();        containerRegistry.RegisterDialog<HistoricalLogView, HistoricalLogViewModel>();        containerRegistry.RegisterDialog<LoggerConfigView, LoggerConfigViewModel>();        containerRegistry.RegisterDialog<LoggerDetailView, LoggerDetailViewModel>();        // 7. 注册主视图模型单例        if (containerRegistry is IContainerExtension containerExtension)        {            LoggerMainViewModel mainVM = new(containerExtension);            _ = containerExtension.RegisterInstance(mainVM);        }        else        {            throw new InvalidOperationException("ContainerRegistry must be an instance of IContainerExtension to register MainViewModel.");        }        // 8. 初始化日志数据库并启动日志清理定时任务.        OnInitialized();    }    /// <summary>    /// 应用初始化时调用，初始化数据库并启动日志清理定时任务.<br/>    /// Prism 应用程序的 OnInitialized 方法通常在应用程序启动时调用，<br/>    /// </summary>    public static void OnInitialized()    {        // 初始化数据库        IDatabaseService? dbService = Ioc.Resolve<IDatabaseService>();        if (dbService != null)        {            _ = dbService.InitializeDatabase();            // 启动定时任务，定期清理旧日志            ILoggingConfigurationService? logConfigService = Ioc.Resolve<ILoggingConfigurationService>();            if (logConfigService != null)            {                var cleanupTimer = new System.Threading.Timer(                    async _ =>                    {                        // 清理过期日志                        _ = await dbService.CleanupOldLogsAsync(logConfigService.GetLogSourceSettings(), false);                    },                    null,                    dueTime: TimeSpan.Zero,                    TimeSpan.FromHours(24)); // 首次立即执行，之后每24小时执行一次            }            //// 示例：使用日志记录器记录应用启动信息            // BgLoggerSource.General.Info("应用程序已启动.");            //// 记录 MES 系统初始化日志            // BgLoggerSource.MES.Info("MES系统初始化中...");        }    }    /// <summary>    /// 显示日志主视图的对话框窗口.<br/>    /// 该方法异步弹出 MainView，并返回对话框结果.    /// </summary>    /// <returns>对话框结果（IDialogResult），如果未显示则为 null.</returns>    public static async Task<IDialogResult?> ShowViewAsync()    {        return await Ioc.ShowAsync<LoggerMainView>(nameof(LoggerDialogWindow));    }    /// <summary>    /// 导航到实时日志界面.<br/>    /// </summary>    /// <param name="regionName">导航到的区域名称.</param>    /// <param name="configure">设置要传递给目标视图的导航参数（可选）.</param>    /// <returns>导航结果（NavigationResult），如果未导航则为 null.</returns>    public static async Task<NavigationResult?> ShowViewAsync(        string regionName,        Action<INavigationParameters>? configure = null)    {        if (Ioc.RegionManager is null)        {            return await Task.FromResult<NavigationResult>(null!);        }        return await Ioc.RegionManager.RequestNavigateAsync(regionName, nameof(LoggerMainView), configure);    }    /// <summary>    /// 销毁 NLog 日志服务并刷新日志.    /// </summary>    public static void Destroy()    {        var logger = LogManager.GetCurrentClassLogger();        logger.Trace("应用程序正在退出...");        LogManager.Shutdown(); // 刷新并关闭 NLog 目标    }    /// <summary>    /// 异步清理过期的日志条目.    /// </summary>    public static async Task<bool> CleanupAllLogsAsync()    {        if (Ioc.Container!.IsRegistered(typeof(ILoggingConfigurationService)))        {            // 检查是否注册了日志配置服务            ILoggingConfigurationService? logConfigService = Ioc.Resolve<ILoggingConfigurationService>();            if (logConfigService != null)            {                IEnumerable<LogSourceSetting>? settings = logConfigService.GetLogSourceSettings();                if (settings != null && settings.Any())                {                    if (Ioc.Container!.IsRegistered(typeof(IDatabaseService)))                    {                        // 检查是否注册了日志数据服务                        IDatabaseService? databaseService = Ioc.Resolve<IDatabaseService>();                        if (databaseService != null)                        {                            // 清理所有日志                            return await databaseService.CleanupOldLogsAsync(settings, true);                        }                    }                }            }        }        return await Task.FromResult(false);    }    /// <summary>    /// 异步获取历史日志文件大小.    /// </summary>    /// <returns>返回 历史日志文件大小.</returns>    public static async Task<long> GetHistorySizeAsync()    {        try        {            if (Ioc.Container!.IsRegistered(typeof(IDatabaseService)))            {                IDatabaseService? databaseService = Ioc.Resolve<IDatabaseService>();                if (databaseService != null)                {                    return await databaseService.GetHistoryFileSize();                }            }        }        catch (Exception ex)        {            return await Task.FromException<long>(ex);        }        return await Task.FromResult(0L);    }}