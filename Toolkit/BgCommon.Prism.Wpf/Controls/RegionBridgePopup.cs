namespace BgCommon.Prism.Wpf.Controls;/// <summary>/// 支持 Prism 区域桥接功能的增强型弹出控件./// </summary>public class RegionBridgePopup : Popup{    /// <summary>    /// 标识 IsBridgeEnabled 依赖属性.    /// </summary>    public static readonly DependencyProperty IsBridgeEnabledProperty =        DependencyProperty.Register(nameof(IsBridgeEnabled), typeof(bool), typeof(RegionBridgePopup), new PropertyMetadata(true));    /// <summary>    /// 标识 RegionControlName 依赖属性.    /// </summary>    public static readonly DependencyProperty RegionControlNameProperty =        DependencyProperty.Register(nameof(RegionControlName), typeof(string), typeof(RegionBridgePopup), new PropertyMetadata(null));    /// <summary>    /// Initializes a new instance of the <see cref="RegionBridgePopup"/> class.    /// </summary>    public RegionBridgePopup()    {        // 订阅事件以执行桥接逻辑        WeakEventManager<Popup, EventArgs>.AddHandler(this, nameof(this.Opened), this.OnPopupOpened);        WeakEventManager<Popup, RoutedEventArgs>.AddHandler(this, nameof(this.Unloaded), this.OnPopupUnloaded);    }    /// <summary>    /// Gets or sets a value indicating whether 是否启用 Prism 区域桥接功能.    /// </summary>    public bool IsBridgeEnabled    {        get => (bool)this.GetValue(IsBridgeEnabledProperty);        set => this.SetValue(IsBridgeEnabledProperty, value);    }    /// <summary>    /// Gets or sets 需要绑定 Prism 区域的内部控件名称.    /// </summary>    public string RegionControlName    {        get => (string)this.GetValue(RegionControlNameProperty);        set => this.SetValue(RegionControlNameProperty, value);    }    /// <summary>    /// 当 Popup 打开时的处理逻辑.    /// </summary>    /// <param name="sender">事件发送者.</param>    /// <param name="eventArgs">事件参数控制.</param>    private void OnPopupOpened(object? sender, EventArgs eventArgs)    {        if (this.IsBridgeEnabled)        {            this.InjectRegionManager();        }    }    /// <summary>    /// 当 Popup 卸载时的处理逻辑.    /// </summary>    /// <param name="sender">事件发送者.</param>    /// <param name="eventArgs">路由事件参数.</param>    private void OnPopupUnloaded(object? sender, RoutedEventArgs eventArgs)    {        // 移除事件监听        WeakEventManager<Popup, EventArgs>.RemoveHandler(this, nameof(this.Opened), this.OnPopupOpened);        WeakEventManager<Popup, RoutedEventArgs>.RemoveHandler(this, nameof(this.Unloaded), this.OnPopupUnloaded);        // 清理引用以辅助 GC        if (this.Child != null && !string.IsNullOrEmpty(this.RegionControlName))        {            var targetElement = this.FindChildByName(this.Child, this.RegionControlName);            targetElement?.ClearValue(RegionManager.RegionManagerProperty);        }    }    /// <summary>    /// 注入宿主环境的 RegionManager 到内部指定控件.    /// </summary>    private void InjectRegionManager()    {        // 如果没有设置放置目标或目标控件名，则无法注入        if (this.PlacementTarget == null || string.IsNullOrEmpty(this.RegionControlName))        {            return;        }        // 从视觉树向上递归寻找 RegionManager        var manager = GetRegionManagerFromAncestors(this.PlacementTarget);        if (manager == null)        {            return;        }        // 在当前 Popup 的 Child 内容中寻找目标控件        var targetControl = this.FindChildByName(this.Child, this.RegionControlName);        if (targetControl != null)        {            RegionManager.SetRegionManager(targetControl, manager);        }    }    /// <summary>    /// 递归寻找指定名称的子控件.    /// </summary>    /// <param name="parent">父级对象.</param>    /// <param name="name">目标控件名称.</param>    /// <returns>找到的依赖对象，若未找到则返回 null.</returns>    private DependencyObject? FindChildByName(DependencyObject parent, string name)    {        if (parent == null)        {            return null;        }        int childrenCount = VisualTreeHelper.GetChildrenCount(parent);        for (int i = 0; i < childrenCount; i++)        {            var childObject = VisualTreeHelper.GetChild(parent, i);            if (childObject is FrameworkElement frameworkElement && frameworkElement.Name == name)            {                return frameworkElement;            }            var recursiveResult = this.FindChildByName(childObject, name);            if (recursiveResult != null)            {                return recursiveResult;            }        }        return null;    }    /// <summary>    /// 从指定对象的视觉树向上查找 RegionManager.    /// </summary>    /// <param name="target">起始查找对象.</param>    /// <returns>找到的 IRegionManager 实例，若未找到则返回 null.</returns>    private static IRegionManager? GetRegionManagerFromAncestors(DependencyObject target)    {        ArgumentNullException.ThrowIfNull(target, nameof(target));        DependencyObject? currentObject = target;        while (currentObject != null)        {            var manager = RegionManager.GetRegionManager(currentObject);            if (manager != null)            {                return manager;            }            // 移动到视觉树父节点            currentObject = VisualTreeHelper.GetParent(currentObject);        }        return null;    }}