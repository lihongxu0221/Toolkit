namespace BgCommon.Localization;/// <summary>/// 多语言资源提供器工厂类./// </summary>public static class LocalizationProviderFactory{    private static readonly ConcurrentDictionary<string, ILocalizationProvider> Instances = new ConcurrentDictionary<string, ILocalizationProvider>();    /// <summary>    /// 获取多语言资源提供器实例.    /// </summary>    /// <returns>返回 多语言资源提供器实例.</returns>    public static ILocalizationProvider? GetInstance()    {        return GetInstance(string.Empty);    }    /// <summary>    /// 获取多语言资源提供器实例.    /// </summary>    /// <param name="key">实例注入的关键字.</param>    /// <returns>返回 多语言资源提供器实例.</returns>    public static ILocalizationProvider? GetInstance(string key)    {        _ = Instances.TryGetValue(key, out ILocalizationProvider? instance);        return instance;    }    /// <summary>    /// 设置多语言资源提供器实例.    /// </summary>    /// <param name="provider">多语言资源提供器实例.</param>    public static void SetInstance(ILocalizationProvider provider)    {        SetInstance(provider, string.Empty);    }    /// <summary>    /// 设置多语言资源提供器实例.    /// </summary>    /// <param name="provider">多语言资源提供器实例.</param>    /// <param name="key">实例注入的关键字.</param>    public static void SetInstance(ILocalizationProvider provider, string key)    {        _ = Instances.AddOrUpdate(key, provider, (_, _) => provider);    }    /// <summary>    /// 获取多语言字符串资源.    /// </summary>    /// <param name="key">关键字.</param>    /// <param name="args">可变格式化字符串参数.</param>    /// <returns>多语言字符串资源.</returns>    public static string GetString(string key, params object[] args)    {        Assembly? assembly = Assembly.GetCallingAssembly();        return GetString(assembly?.GetName()?.Name, key, args);    }    /// <summary>    /// 获取多语言字符串资源.    /// </summary>    /// <param name="language">指定多语言.</param>    /// <param name="key">关键字.</param>    /// <param name="args">可变格式化字符串参数.</param>    /// <returns>多语言字符串资源.</returns>    public static string GetString(LanguageEnum language, string key, params object[] args)    {        CultureInfo? cultureInfo = null;        try        {            cultureInfo = new CultureInfo((int)language);        }        catch        {            cultureInfo = GetInstance()?.GetCulture();        }        return GetString(cultureInfo, key, args);    }    /// <summary>    /// 获取多语言字符串资源.    /// </summary>    /// <param name="cultureInfo">指定多语言.</param>    /// <param name="key">关键字.</param>    /// <param name="args">可变格式化字符串参数.</param>    /// <returns>多语言字符串资源.</returns>    public static string GetString(CultureInfo? cultureInfo, string key, params object[] args)    {        if (cultureInfo == null)        {            cultureInfo = GetInstance()?.GetCulture();        }        Assembly? assembly = Assembly.GetCallingAssembly();        return GetString(cultureInfo, assembly?.GetName()?.Name, key, args);    }    /// <summary>    /// 获取多语言字符串资源.    /// </summary>    /// <param name="assemblyName">资源包所在程序集名称.</param>    /// <param name="key">关键字.</param>    /// <param name="args">可变格式化字符串参数.</param>    /// <returns>多语言字符串资源.</returns>    public static string GetString(string? assemblyName, string key, params object[] args)    {        return GetString(GetInstance()?.GetCulture(), assemblyName, key, args);    }    /// <summary>    /// 获取多语言字符串资源.    /// </summary>    /// <param name="cultureInfo">指定的语言环境.</param>    /// <param name="assemblyName">资源包所在程序集名称.</param>    /// <param name="key">关键字.</param>    /// <param name="args">可变格式化字符串参数.</param>    /// <returns>多语言字符串资源.</returns>    public static string GetString(CultureInfo? cultureInfo, string? assemblyName, string key, params object[] args)    {        if (cultureInfo == null)        {            cultureInfo = GetInstance()?.GetCulture();        }        if (string.IsNullOrEmpty(key))        {            return key;        }        bool isContainsEscape = false;        string tranText = key;        if (tranText.Contains('\\'))        {            isContainsEscape = true;        }        tranText = GetInstance()?.GetString(key, cultureInfo, assemblyName) ?? key;        if (tranText.Contains('\\'))        {            isContainsEscape = true;        }        if (args.Length > 0)        {            MatchCollection matches = new Regex("\\{(.*?)\\}").Matches(tranText);            if (matches.Count != args.Length)            {                return key;            }            for (int i = 0; i < args.Length; i++)            {                tranText = string.Format(tranText.Replace("{", "{{").Replace("}", "}}").Replace("{" + matches[i].Value + "}", "{0}"), args[i]);            }        }        if (isContainsEscape)        {            tranText = Regex.Unescape(tranText);        }        return tranText;    }    /// <summary>    /// 获取指定关键字对应的的全部语言字符串数组.    /// </summary>    /// <param name="key">关键字.</param>    /// <param name="assemblyName">程序集名称.</param>    /// <returns>返回 全部语言字符串数组.</returns>    public static string[] GetStrings(string key, string? assemblyName = "")    {        if (string.IsNullOrEmpty(assemblyName))        {            Assembly? assembly = Assembly.GetCallingAssembly();            assemblyName = assembly.GetName()?.Name;        }        List<CultureInfo> cultureInfos = new List<CultureInfo>();        Array enumValues = Enum.GetValues(typeof(LanguageEnum));        for (int i = 0; i < enumValues.Length; i++)        {            try            {                CultureInfo culture = new CultureInfo((int)enumValues.GetValue(i));                cultureInfos.Add(culture);            }            catch            {                continue;            }        }        string[] array = GetInstance()?.GetStrings(key, assemblyName, cultureInfos.ToArray())!;        cultureInfos.Clear();        return array;    }}