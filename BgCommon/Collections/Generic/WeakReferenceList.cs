namespace BgCommon.Collections.Generic;/// <summary>/// 提供一个基于弱引用（WeakReference）存储对象的泛型列表./// 该列表允许其包含的元素在没有其他强引用指向时被垃圾回收器（GC）回收，从而防止内存泄漏./// </summary>/// <typeparam name="T">列表中元素的类型。必须是引用类型.</typeparam>public class WeakReferenceList<T> : IList<T?>    where T : class{    /// <summary>    /// 内部存储弱引用的底层列表.    /// </summary>    private readonly List<WeakReference<T>> items = new List<WeakReference<T>>();    /// <summary>    /// Gets 列表中包含的元素总数（包括已失效的弱引用）.    /// </summary>    public int Count => items.Count;    /// <summary>    /// Gets a value indicating whether 列表是否为只读.    /// </summary>    public bool IsReadOnly => false;    /// <summary>    /// 获取或设置指定索引处的元素.    /// </summary>    /// <param name="index">要获取或设置的从零开始的索引.</param>    /// <returns>如果元素仍然存活且未被回收，则返回该元素；否则返回 <see langword="null"/>.</returns>    /// <exception cref="ArgumentOutOfRangeException">索引超出范围时抛出.</exception>    public T? this[int index]    {        get        {            if (items[index].TryGetTarget(out T? target))            {                return target;            }            return null;        }        set        {            if (index >= 0 && index < items.Count)            {                items[index] = new WeakReference<T>(value!);                return;            }            throw new ArgumentOutOfRangeException(nameof(index), "索引超出了范围.");        }    }    /// <summary>    /// 搜索指定对象，并返回整个列表中第一个匹配项的从零开始的索引.    /// </summary>    /// <param name="item">要在列表中定位的对象.</param>    /// <returns>如果找到则为该项的索引；否则为 -1.</returns>    public int IndexOf(T? item)    {        var comparer = EqualityComparer<T>.Default;        for (int i = 0; i < items.Count; i++)        {            if (items[i].TryGetTarget(out T? target) && comparer.Equals(target, item!))            {                return i;            }        }        return -1;    }    /// <summary>    /// 将元素插入到列表中的指定索引处.    /// </summary>    /// <param name="index">应插入该对象的从零开始的索引.</param>    /// <param name="item">要插入的对象.</param>    public void Insert(int index, T? item)    {        items.Insert(index, new WeakReference<T>(item!));    }    /// <summary>    /// 移除列表中指定索引处的元素.    /// </summary>    /// <param name="index">要移除的元素的从零开始的索引.</param>    public void RemoveAt(int index)    {        items.RemoveAt(index);    }    /// <summary>    /// 将对象包装为弱引用并添加到列表的末尾.    /// </summary>    /// <param name="item">要添加的对象.</param>    public void Add(T? item)    {        items.Add(new WeakReference<T>(item!));    }    /// <summary>    /// 从列表中移除所有元素.    /// </summary>    public void Clear()    {        items.Clear();    }    /// <summary>    /// 确定列表中是否包含特定的存活值.    /// </summary>    /// <param name="item">要在列表中定位的对象.</param>    /// <returns>如果找到匹配的存活对象则为 true；否则为 false.</returns>    public bool Contains(T? item)    {        return IndexOf(item) > -1;    }    /// <summary>    /// 从指定的数组索引开始，将列表中的所有存活元素复制到一个数组中.    /// </summary>    /// <param name="array">作为复制目标的一维数组.</param>    /// <param name="arrayIndex">数组中开始复制的从零开始的索引.</param>    public void CopyTo(T?[] array, int arrayIndex)    {        for (int i = 0; i < items.Count; i++)        {            items[i].TryGetTarget(out T? target);            array[arrayIndex + i] = target;        }    }    /// <summary>    /// 从列表中移除特定对象的第一个匹配项.    /// </summary>    /// <param name="item">要从列表中移除的对象.</param>    /// <returns>如果移除成功则为 true；否则为 false.</returns>    public bool Remove(T? item)    {        int index = IndexOf(item);        if (index < 0)        {            return false;        }        RemoveAt(index);        return true;    }    /// <summary>    /// 返回一个循环访问存活元素集合的枚举器.    /// </summary>    /// <returns>用于循环访问集合的枚举器.</returns>    public IEnumerator<T?> GetEnumerator()    {        foreach (var weakRef in items)        {            if (weakRef.TryGetTarget(out T? target))            {                yield return target;            }            else            {                yield return null;            }        }    }    /// <summary>    /// 返回一个循环访问集合的枚举器（非泛型版本）.    /// </summary>    /// <returns>用于循环访问集合的枚举器.</returns>    IEnumerator IEnumerable.GetEnumerator()    {        return GetEnumerator();    }}