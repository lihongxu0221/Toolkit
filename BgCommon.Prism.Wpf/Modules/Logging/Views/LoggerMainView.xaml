<UserControl x:Class="BgCommon.Prism.Wpf.Modules.Logging.Views.LoggerMainView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:hc="https://handyorg.github.io/handycontrol"
             xmlns:bg="http://www.sz-baigu.com/"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:m="clr-namespace:BgCommon.Prism.Wpf.Modules.Logging.Models"
             xmlns:vm="clr-namespace:BgCommon.Prism.Wpf.Modules.Logging.ViewModels"
             xmlns:vw="clr-namespace:BgCommon.Prism.Wpf.Modules.Logging.Views"   
             xmlns:markup="clr-namespace:BgCommon.Prism.Wpf.Localization.Markup"
             prism:ViewModelLocator.AutoWireViewModel="True" 
             d:DataContext="{d:DesignInstance Type=vm:LoggerMainViewModel}"
             mc:Ignorable="d" d:DesignHeight="768" d:DesignWidth="1024"
             FontSize="{DynamicResource TextFontSize}"
             Foreground="{DynamicResource PrimaryTextBrush}"
             bg:CommandProvider.LoadedCommand="{Binding LoadedCommand}">
    <UserControl.Resources>
        <ResourceDictionary Source="pack://application:,,,/BgCommon.Prism.Wpf;component/Assets/Style/General.xaml" />
    </UserControl.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="160"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Border Grid.Column="0" CornerRadius="5" Margin="5 5 0 5" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
            <DockPanel LastChildFill="True">
                <Grid DockPanel.Dock="Top" Height="46">
                    <TextBlock Text="{markup:StringResource 数据来源}" Margin="10 0 0 0" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="{DynamicResource SubHeadFontSize}" Foreground="{DynamicResource PrimaryTextBrush}" FontWeight="Bold"/>
                </Grid>
                <ListBox Grid.Column="0" Style="{DynamicResource ListBoxBaseStyle}" 
                         HorizontalContentAlignment="Stretch" 
                         VerticalContentAlignment="Stretch" 
                         ItemsSource="{Binding LogSources}" 
                         SelectedItem="{Binding SelectedLogSourceDisplay}" 
                         BorderBrush="{DynamicResource BorderBrush}" 
                         d:ItemsSource="{d:SampleData ItemCount=4}" 
                         BorderThickness="0 1 0 0"
                         VirtualizingPanel.IsVirtualizing="True" 
                         VirtualizingPanel.VirtualizationMode="Recycling">
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel FocusVisualStyle="{x:Null}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="m:LogSourceDisplay">
                            <Grid x:Name="bd" HorizontalAlignment="Stretch" Background="Transparent" Effect="{DynamicResource EffectShadow2}">
                                <!--<Image HorizontalAlignment="Left" VerticalAlignment="Center" Margin="10" Source="{Binding Image}" Stretch="Uniform"/>-->
                                <TextBlock Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" Text="{Binding Source}" Foreground="{DynamicResource PrimaryTextBrush}" FontSize="{DynamicResource TextFontSize}"/>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Margin" Value="10 10 10 0"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                            <Setter Property="BorderThickness" Value="1"/>
                            <Setter Property="hc:BorderElement.CornerRadius" Value="5"/>
                            <Setter Property="Height" Value="48"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="{x:Type ListBoxItem}">
                                        <Border Name="Bd" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" SnapsToDevicePixels="true" CornerRadius="{Binding Path=(hc:BorderElement.CornerRadius), RelativeSource={RelativeSource TemplatedParent}}">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}" SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="UIElement.IsMouseOver" Value="true">
                                                <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                                                <Setter Property="BorderThickness" Value="1"/>
                                            </Trigger>
                                            <Trigger Property="ListBoxItem.IsSelected" Value="true">
                                                <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </Trigger>
                                            <MultiTrigger>
                                                <MultiTrigger.Conditions>
                                                    <Condition Property="ListBoxItem.IsSelected" Value="true"/>
                                                    <Condition Property="Selector.IsSelectionActive" Value="false"/>
                                                </MultiTrigger.Conditions>
                                                <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                                                <Setter Property="Foreground" Value="{DynamicResource PrimaryBrush}"/>
                                                <Setter Property="BorderThickness" Value="1"/>
                                            </MultiTrigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </DockPanel>
        </Border>
        <DockPanel Grid.Column="1" Grid.Row="0" LastChildFill="True">
            <Border Height="46" Margin="5" CornerRadius="5" DockPanel.Dock="Top" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                <Grid Background="{DynamicResource RegionBrush}">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                        <ComboBox Style="{DynamicResource ComboBoxExtend}" 
                                  ItemsSource="{Binding AllLevels}" 
                                  SelectedItem="{Binding SelectedLevel}" 
                                  DisplayMemberPath="Name"
                                  bg:TitleElement.TitleWidth="Auto"
                                  bg:TitleElement.TitlePlacement="Left"
                                  bg:TitleElement.ShowClearButton="False"
                                  bg:TitleElement.Necessary="False"
                                  bg:TitleElement.Title="{markup:StringResource 级别, StringFormat={}{0}: }"
                                  Width="160" Margin="10 0 0 0"/>
                        <Button Width="100" Height="32" Content="{markup:StringResource 历史日志}" Command="{Binding ShowHistoricalLogsCommand}" Margin="10 0 0 0"/>
                        <Button Width="100" Height="32" Content="{markup:StringResource 测试}" 
                                bg:CommandProvider.PreviewMouseDown="{Binding LogTestCommand}"
                                bg:CommandProvider.PreviewMouseUp="{Binding LogTestCancelCommand}"
                                bg:CommandProvider.CommandParameter="{Binding SelectedLogSourceDisplay}"
                                Margin="10 0 0 0"/>
                        <Button Width="100" Height="32" Content="{markup:StringResource 清除实时}" Command="{Binding ClearRealTimeLogsCommand}" Margin="10 0 0 0"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                        <!--<Button Content="{markup:StringResource 刷新}" Command="{Binding RefreshRealTimeLogsCommand}" Margin="5" Visibility="Collapsed"/>-->
                        <Button Style="{StaticResource Button.FontIcon1}" BorderThickness="0" Background="Transparent" 
                                HorizontalAlignment="Right" VerticalAlignment="Center" 
                                bg:IconElement.FontIcon="&#xe924;" 
                                bg:IconElement.DisplayStyle="Image"
                                bg:IconElement.Margin="0" 
                                Command="{Binding ShowConfigDialogCommand}" 
                                ToolTip="{markup:StringResource 日志数据源参数设置}"/>
                    </StackPanel>
                </Grid>
            </Border>
            <DataGrid Grid.Column="1" Margin="5" 
                      ItemsSource="{Binding  SelectedLogSourceDisplay.FilteredRealTimeLogs}" 
                      AutoGenerateColumns="False"
                      IsReadOnly="True" 
                      CanUserSortColumns="False"
                      CanUserAddRows="False" 
                      CanUserDeleteRows="False"
                      VirtualizingPanel.IsVirtualizing="True" 
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      RowStyle="{DynamicResource LogRowStyle}">
                <bg:Interaction.Triggers>
                    <bg:EventTrigger EventName="MouseDoubleClick">
                        <bg:InvokeCommandAction Command="{Binding RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}, Path=DataContext.ShowDetailedLogCommand}"
                                                CommandParameter="{Binding RelativeSource={RelativeSource AncestorType={x:Type DataGrid}}, Path=SelectedItem}"/>
                    </bg:EventTrigger>
                </bg:Interaction.Triggers>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="{markup:StringResource 时间}" Width="Auto" Binding="{Binding Timestamp, StringFormat='yyyy-MM-dd HH:mm:ss.fff'}"/>
                    <DataGridTextColumn Header="{markup:StringResource 级别}" Width="Auto" Binding="{Binding Level}"/>
                    <!--<DataGridTextColumn Header="{markup:StringResource 来源}" Width="120" Binding="{Binding Source}"/>-->
                    <DataGridTextColumn Header="{markup:StringResource 信息}" Width="Auto" Binding="{Binding Message}"/>
                    <DataGridTextColumn Header="{markup:StringResource 异常信息}" Width="Auto" Binding="{Binding ExceptionInfo}"/>
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>
        <StatusBar Grid.ColumnSpan="2" Grid.Row="1">
            <StatusBarItem HorizontalAlignment="Left">
                <TextBlock Text="{Binding Status}" />
            </StatusBarItem>
        </StatusBar>
        <Grid Grid.ColumnSpan="2" Grid.RowSpan="2" Margin="5" Visibility="{Binding IsLoading ,Converter={StaticResource Boolean2VisibilityConverter}}">
            <Border Background="{DynamicResource RegionBrush}" Opacity="0.3"/>
            <Border HorizontalAlignment="Center" VerticalAlignment="Center" Background="{DynamicResource PrimaryBrush}" CornerRadius="10">
                <hc:LoadingCircle Style="{StaticResource LoadingCircleLight}" Margin="10"/>
            </Border>
        </Grid>
    </Grid>
</UserControl>